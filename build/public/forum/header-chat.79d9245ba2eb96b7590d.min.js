"use strict";(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[1091,13201,34271,49897,99127],{11599:(P,w,l)=>{var g,p;g=[l(52473),l(91749),l(49897)],p=function(m,L,v){const d={};d.prepareDOM=function(){const u=$('[component="chat/dropdown"]');u.on("show.bs.dropdown",s=>{f("loadChatsDropdown",$(s.target).parent().find('[component="chat/list"]'))}),u.each((s,c)=>{const e=$(c).parent().find(".dropdown-menu");e.hasClass("show")&&f("loadChatsDropdown",e.find('[component="chat/list"]'))}),socket.removeListener("event:chats.receive",E),socket.on("event:chats.receive",E),socket.removeListener("event:chats.typing",C),socket.on("event:chats.typing",C),socket.removeListener("event:chats.roomRename",k),socket.on("event:chats.roomRename",k),socket.on("event:unread.updateChatCount",async function(s){if(s){const[r,a]=await app.require(["chat","forum/chats"]);if(r.isFromBlockedUser(s.fromUid)||r.isLookingAtRoom(s.roomId)||app.user.uid===parseInt(s.fromUid,10))return;a.markChatPageElUnread(s),a.updateTeaser(s.roomId,s.teaser)}let{count:c}=await v.get("/chats/unread");const e=m.get("chat/icon");c=Math.max(0,c),e.toggleClass("fa-comment",c>0).toggleClass("fa-comment-o",c<=0);const t=c>99?"99+":c;m.get("chat/icon").toggleClass("unread-count",c>0).attr("data-content",t),m.get("chat/count").toggleClass("hidden",c<=0).text(t),L.fire("action:chat.updateCount",{count:c})})};function E(u){f("onChatMessageReceived",u)}function C(u){f("onUserTyping",u)}function k(u){f("onRoomRename",u)}async function f(u,s){(await app.require("chat"))[u](s)}return d}.apply(w,g),p!==void 0&&(P.exports=p)},49897:(P,w,l)=>{l.r(w),l.d(w,{del:()=>c,get:()=>C,head:()=>k,patch:()=>u,post:()=>f,put:()=>s});var g=l(91749),p=l.n(g),m=l(33530),L=l.n(m);const v=config.relative_path+"/api/v3";async function d(e,t){if(e.url=e.url.startsWith("/api")?config.relative_path+e.url:v+e.url,typeof t=="function"){E(e).then(r=>t(null,r),r=>{let a=r;r instanceof Error||(a=new Error(String(r)));const i=a.message||String(a);if(i&&!i.startsWith("[[error:")&&(i.toLowerCase()==="fetch failed"||i.toLowerCase()==="failed to fetch"||i.toLowerCase().includes("networkerror")||i.toLowerCase().includes("network")&&i.toLowerCase().includes("failed"))){const o=new Error("[[error:no-connection]]");o.originalError=a,a=o}t(a)});return}try{return await E(e)}catch(r){if(r.message==="A valid login session was not found. Please log in and try again."){const{url:a}=await(0,g.fire)("filter:admin.reauth",{url:"login"});return(0,m.confirm)("[[error:api.reauth-required]]",i=>{i&&ajaxify.go(a)})}throw r}}async function E(e){const{url:t}=e;delete e.url,e.headers||(e.headers={}),e.data&&!(e.data instanceof FormData)&&(e.data=JSON.stringify(e.data||{}),e.headers["content-type"]="application/json; charset=utf-8");try{({options:e}=await(0,g.fire)("filter:api.options",{options:e}))}catch(n){console.error("[API] Error in filter:api.options hook:",n)}e.data&&(e.body=e.data,delete e.data);let r;try{r=await fetch(t,e)}catch(n){const h=n.message||n.toString()||String(n),T=n.name||"Error";if(T==="TypeError"&&(h.toLowerCase().includes("fetch")||h.toLowerCase().includes("network")||h.toLowerCase().includes("failed to fetch")||h.toLowerCase().includes("load failed"))||h.toLowerCase().includes("cors")||h.toLowerCase().includes("networkerror")){console.error("[API] Network error:",{url:t,method:e.method||"GET",error:h,name:T});const x=new Error("[[error:no-connection]]");throw x.originalError=n,x}throw console.error("[API] Unexpected fetch error:",{url:t,method:e.method||"GET",error:h,name:T}),n}const{headers:a}=r;if(a.get("x-redirect"))return E({url:a.get("x-redirect"),...e});const i=a.get("content-type"),y=i&&i.startsWith("application/json");let o;if(e.method!=="HEAD")try{y?o=await r.json():o=await r.text()}catch(n){throw console.error("[API] Error parsing response:",{url:t,status:r.status,statusText:r.statusText,contentType:i,error:n.message}),new Error("[[error:invalid-json]]")}if(!r.ok){let n;throw o?y&&o.status&&o.status.message?n=o.status.message:typeof o=="string"?n=o:n=r.statusText||"Request failed":n=r.statusText||"Request failed",new Error(n)}return y&&o&&o.hasOwnProperty("status")&&o.hasOwnProperty("response")?o.response:o}function C(e,t,r){return d({url:e+(t&&Object.keys(t).length?"?"+$.param(t):"")},r)}function k(e,t,r){return d({url:e+(t&&Object.keys(t).length?"?"+$.param(t):""),method:"HEAD"},r)}function f(e,t,r){return d({url:e,method:"POST",data:t,headers:{"x-csrf-token":config.csrf_token}},r)}function u(e,t,r){return d({url:e,method:"PATCH",data:t,headers:{"x-csrf-token":config.csrf_token}},r)}function s(e,t,r){return d({url:e,method:"PUT",data:t,headers:{"x-csrf-token":config.csrf_token}},r)}function c(e,t,r){return d({url:e,method:"DELETE",data:t,headers:{"x-csrf-token":config.csrf_token}},r)}}}]);
