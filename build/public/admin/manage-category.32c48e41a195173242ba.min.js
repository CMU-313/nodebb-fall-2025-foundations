"use strict";(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[1091,34271,49897,69185,83931,86198,99127],{49897:(k,v,g)=>{g.r(v),g.d(v,{del:()=>d,get:()=>o,head:()=>s,patch:()=>c,post:()=>h,put:()=>m});var p=g(91749),C=g.n(p),b=g(33530),x=g.n(b);const w=config.relative_path+"/api/v3";async function y(n,r){if(n.url=n.url.startsWith("/api")?config.relative_path+n.url:w+n.url,typeof r=="function"){f(n).then(e=>r(null,e),e=>{let t=e;e instanceof Error||(t=new Error(String(e)));const a=t.message||String(t);if(a&&!a.startsWith("[[error:")&&(a.toLowerCase()==="fetch failed"||a.toLowerCase()==="failed to fetch"||a.toLowerCase().includes("networkerror")||a.toLowerCase().includes("network")&&a.toLowerCase().includes("failed"))){const i=new Error("[[error:no-connection]]");i.originalError=t,t=i}r(t)});return}try{return await f(n)}catch(e){if(e.message==="A valid login session was not found. Please log in and try again."){const{url:t}=await(0,p.fire)("filter:admin.reauth",{url:"login"});return(0,b.confirm)("[[error:api.reauth-required]]",a=>{a&&ajaxify.go(t)})}throw e}}async function f(n){const{url:r}=n;delete n.url,n.headers||(n.headers={}),n.data&&!(n.data instanceof FormData)&&(n.data=JSON.stringify(n.data||{}),n.headers["content-type"]="application/json; charset=utf-8");try{({options:n}=await(0,p.fire)("filter:api.options",{options:n}))}catch(l){console.error("[API] Error in filter:api.options hook:",l)}n.data&&(n.body=n.data,delete n.data);let e;try{e=await fetch(r,n)}catch(l){const E=l.message||l.toString()||String(l),A=l.name||"Error";if(A==="TypeError"&&(E.toLowerCase().includes("fetch")||E.toLowerCase().includes("network")||E.toLowerCase().includes("failed to fetch")||E.toLowerCase().includes("load failed"))||E.toLowerCase().includes("cors")||E.toLowerCase().includes("networkerror")){console.error("[API] Network error:",{url:r,method:n.method||"GET",error:E,name:A});const L=new Error("[[error:no-connection]]");throw L.originalError=l,L}throw console.error("[API] Unexpected fetch error:",{url:r,method:n.method||"GET",error:E,name:A}),l}const{headers:t}=e;if(t.get("x-redirect"))return f({url:t.get("x-redirect"),...n});const a=t.get("content-type"),u=a&&a.startsWith("application/json");let i;if(n.method!=="HEAD")try{u?i=await e.json():i=await e.text()}catch(l){throw console.error("[API] Error parsing response:",{url:r,status:e.status,statusText:e.statusText,contentType:a,error:l.message}),new Error("[[error:invalid-json]]")}if(!e.ok){let l;throw i?u&&i.status&&i.status.message?l=i.status.message:typeof i=="string"?l=i:l=e.statusText||"Request failed":l=e.statusText||"Request failed",new Error(l)}return u&&i&&i.hasOwnProperty("status")&&i.hasOwnProperty("response")?i.response:i}function o(n,r,e){return y({url:n+(r&&Object.keys(r).length?"?"+$.param(r):"")},e)}function s(n,r,e){return y({url:n+(r&&Object.keys(r).length?"?"+$.param(r):""),method:"HEAD"},e)}function h(n,r,e){return y({url:n,method:"POST",data:r,headers:{"x-csrf-token":config.csrf_token}},e)}function c(n,r,e){return y({url:n,method:"PATCH",data:r,headers:{"x-csrf-token":config.csrf_token}},e)}function m(n,r,e){return y({url:n,method:"PUT",data:r,headers:{"x-csrf-token":config.csrf_token}},e)}function d(n,r,e){return y({url:n,method:"DELETE",data:r,headers:{"x-csrf-token":config.csrf_token}},e)}},65348:(k,v,g)=>{var p,C;p=[g(96349),g(33530),g(91749),g(17459)],C=function(b,x,w,y){const f={};return f.init=function(o,s){if(!o||!o.length)return;s=s||{};const h=s.onSelect||function(){};s.states=s.states||["watching","tracking","notwatching","ignoring"],s.template=s.template||"partials/category/selector-dropdown-left",w.fire("action:category.selector.options",{el:o,options:s}),b.init(o,s);const c={el:o,selectedCategory:null};o.on("click","[data-cid]",function(){const d=$(this);return d.hasClass("disabled")?!1:(c.selectCategory(d.attr("data-cid")),h(c.selectedCategory))});let m=c.el.find('[component="category-selector-selected"]').html();return y.translate(m,d=>{m=d}),c.selectCategory=function(d){const n=c.el.find('[data-cid="'+d+'"]');c.selectedCategory={cid:d,name:n.attr("data-name")},n.length?c.el.find('[component="category-selector-selected"]').html(n.find('[component="category-markup"]').html()):c.el.find('[component="category-selector-selected"]').html(m)},c.getSelectedCategory=function(){return c.selectedCategory},c.getSelectedCid=function(){return c.selectedCategory?c.selectedCategory.cid:0},s.hasOwnProperty("selectedCategory")&&app.parseAndTranslate(s.template,{selectedCategory:s.selectedCategory},function(d){c.el.find('[component="category-selector-selected"]').html(d.find('[component="category-selector-selected"]').html())}),c},f.modal=function(o){o=o||{},o.onSelect=o.onSelect||function(){},o.onSubmit=o.onSubmit||function(){},app.parseAndTranslate("admin/partials/categories/select-category",{message:o.message},function(s){const h=x.dialog({title:o.title||"[[modules:composer.select-category]]",message:s,buttons:{save:{label:"[[global:select]]",className:"btn-primary",callback:m}}}),c=f.init(h.find('[component="category-selector"]'),o);function m(d){return d.preventDefault(),c.selectedCategory&&(o.onSubmit(c.selectedCategory),h.modal("hide")),!1}o.openOnLoad&&h.on("shown.bs.modal",function(){h.find(".dropdown-toggle").dropdown("toggle")}),h.find("form").on("submit",m)})},f}.apply(v,p),C!==void 0&&(k.exports=C)},86871:(k,v,g)=>{var p,C;p=[g(24187),g(67308),g(65348),g(81335),g(49897),g(33530),g(29930),g(54222)],C=function(b,x,w,y,f,o,s,h){const c={};let m={};c.init=function(){const r=$("#category-settings"),e=$('[component="category/preview"]');r.find("select").each(function(){const t=$(this);t.val(t.attr("data-value"))}),w.init($('[component="settings/main/header"] [component="category-selector"]'),{onSelect:function(t){ajaxify.go("admin/manage/categories/"+t.cid)},cacheList:!1,showLinks:!0,template:"admin/partials/category/selector-dropdown-right"}),w.init($('#parent-category-selector [component="category-selector"]'),{onSelect:function(t){const a=$("#parent-cid");a.val(t.cid),d(a[0])},selectedCategory:ajaxify.data.category.parent,localCategories:[{cid:0,name:"[[admin/manage/categories:parent-category-none]]",icon:"fa-list"}],cacheList:!1,showLinks:!0,template:"admin/partials/category/selector-dropdown-right"}),n(),r.find("input, select, textarea").on("change",function(t){d(t.target)}),$('[type="checkbox"]').on("change",function(){d($(this))}),$('[data-name="imageClass"]').on("change",function(){$(".category-preview").css("background-size",$(this).val())}),$('[data-name="bgColor"], [data-name="color"]').on("input",function(){const t=$(this);t.attr("data-name")==="bgColor"?e.css("background-color",t.val()):t.attr("data-name")==="color"&&e.css("color",t.val()),d(t[0])}),$("#save").on("click",function(){const t=$("#tag-whitelist").val()?$("#tag-whitelist").val().split(","):[];if(t.length&&t.length<parseInt($("#cid-min-tags").val(),10))return s.error("[[admin/manage/categories:alert.not-enough-whitelisted-tags]]");const a=ajaxify.data.category.cid;return f.put("/categories/"+a,m).then(()=>{app.flags._unsaved=!1,h.toggleSaveSuccess($("#save")),m={}}).catch(s.error),!1}),$(".purge").on("click",function(t){t.preventDefault(),y.render("admin/partials/categories/purge",{name:ajaxify.data.category.name,topic_count:ajaxify.data.category.topic_count}).then(function(a){const u=o.dialog({title:"[[admin/manage/categories:purge]]",message:a,size:"large",buttons:{save:{label:"[[modules:bootbox.confirm]]",className:"btn-primary",callback:function(){u.find(".modal-footer button").prop("disabled",!0);const i=setInterval(async()=>{if(ajaxify.data.category)try{const{count:l}=await f.get(`/categories/${ajaxify.data.category.cid}/count`);let E=0;ajaxify.data.category.topic_count>0&&(E=Math.max(0,1-l/ajaxify.data.category.topic_count)*100),u.find(".progress-bar").css({width:E+"%"})}catch(l){clearInterval(i),s.error(l)}},1e3);return f.del("/categories/"+ajaxify.data.category.cid).then(()=>{i&&clearInterval(i),u.modal("hide"),s.success("[[admin/manage/categories:alert.purge-success]]"),setTimeout(()=>{ajaxify.go("admin/manage/categories")},2500)}).catch(s.error),!1}}}})})}),$(".copy-settings").on("click",function(){return y.render("admin/partials/categories/copy-settings",{}).then(function(t){let a;const u=o.dialog({title:"[[modules:composer.select-category]]",message:t,buttons:{save:{label:"[[modules:bootbox.confirm]]",className:"btn-primary",callback:function(){if(!(!a||parseInt(a,10)===parseInt(ajaxify.data.category.cid,10)))return socket.emit("admin.categories.copySettingsFrom",{fromCid:a,toCid:ajaxify.data.category.cid,copyParent:u.find("#copyParent").prop("checked")},function(i){if(i)return s.error(i);u.modal("hide"),alert.success("[[admin/manage/categories:alert.copy-success]]"),ajaxify.refresh()}),!1}}}});u.find(".modal-footer button").prop("disabled",!0),w.init(u.find('[component="category-selector"]'),{onSelect:function(i){a=i&&i.cid,a&&u.find(".modal-footer button").prop("disabled",!1)},showLinks:!0})}),!1}),$(".upload-button").on("click",function(){const a=$(this).attr("data-cid");b.show({title:"[[admin/manage/categories:alert.upload-image]]",route:config.relative_path+"/api/admin/category/uploadpicture",params:{cid:a}},function(u){$("#category-image").val(u),e.css("background-image","url("+u+"?"+new Date().getTime()+")"),d($("#category-image"))})}),$("#category-image").on("change",function(){e.css("background-image",$(this).val()?'url("'+$(this).val()+'")':""),d($("#category-image"))}),$(".delete-image").on("click",function(t){t.preventDefault();const a=$("#category-image");a.val(""),e.css("background-image",""),d(a[0])}),e.on("click",function(){x.init($(this).find("i"),d)}),$('button[data-action="toggle"]').on("click",function(){const t=$(this),a=t.attr("data-disabled")==="1";f.put("/categories/"+ajaxify.data.category.cid,{disabled:a?0:1}).then(()=>{t.find(".label").translateText(a?"[[admin/manage/categories:disable]]":"[[admin/manage/categories:enable]]"),t.find("i").toggleClass(["fa-check","text-success"],!a).toggleClass(["fa-ban","text-danger"],a),t.attr("data-disabled",a?0:1)}).catch(s.error)})};function d(r){let e;$(r).is(":checkbox")?e=$(r).is(":checked")?1:0:e=$(r).val();const a=$(r).attr("data-name").match(/[^\][.]+/g);function u(i,l){l!==a.length&&(i[a[l]]=i[a[l]]||{},l===a.length-1&&(i[a[l]]=e),u(i[a[l]],l+1))}a&&a.length&&(a.length===1?m[a[0]]=e:a.length>1&&u(m,0)),app.flags=app.flags||{},app.flags._unsaved=!0}function n(){const r=$("#tag-whitelist");r.tagsinput({tagClass:"badge bg-info",confirmKeys:[13,44],trimValue:!0}),ajaxify.data.category.tagWhitelist.forEach(function(e){r.tagsinput("add",e)}),r.on("itemAdded itemRemoved",function(){d(r)})}return c}.apply(v,p),C!==void 0&&(k.exports=C)},96349:(k,v,g)=>{var p,C;p=[g(29930),g(89336),g(49897)],C=function(b,x,w){const y={};return y.init=function(f,o){let s=o.defaultCategories||null;o=o||{},o.privilege=o.privilege||"topics:read",o.states=o.states||["watching","tracking","notwatching","ignoring"],o.cacheList=o.hasOwnProperty("cacheList")?o.cacheList:!0;let h=[];Array.isArray(o.localCategories)&&(h=o.localCategories.map(r=>({...r})),s&&(s=[...h,...s])),o.selectedCids=o.selectedCids||ajaxify.data.selectedCids||[];const c=f.find('[component="category-selector-search"]');if(!c.length)return;const m=c.parents('[component="category/dropdown"]').length>0||c.parents('[component="category-selector"]').length>0;f.on("show.bs.dropdown",function(){m&&c.removeClass("hidden");function r(){const e=c.find("input").val();e.length>1||!e&&!s?d(e,function(t){s=o.cacheList&&(s||t),n(t)}):!e&&s&&n(s)}c.on("click",function(e){e.preventDefault(),e.stopPropagation()}),c.find("input").val("").on("keyup",utils.debounce(r,300)),r()}),f.on("shown.bs.dropdown",function(){["xs","sm"].includes(utils.findBootstrapEnvironment())||c.find("input").focus()}),f.on("hide.bs.dropdown",function(){m&&c.addClass("hidden"),c.off("click"),c.find("input").off("keyup")});function d(r,e){w.get("/search/categories",{search:r,query:utils.params(),parentCid:o.parentCid||0,selectedCids:o.selectedCids,privilege:o.privilege,states:o.states,showLinks:o.showLinks},function(t,{categories:a}){if(t)return b.error(t);e(h.concat(a))})}function n(r){const e=o.selectedCids.map(String);r.forEach(function(t){t.selected=e.includes(String(t.cid))}),app.parseAndTranslate(o.template,{categoryItems:r.slice(0,200),selectedCategory:ajaxify.data.selectedCategory,allCategoriesUrl:ajaxify.data.allCategoriesUrl},function(t){f.find('[component="category/list"]').html(t.find('[component="category/list"]').html()),f.find('[component="category/list"] [component="category/no-matches"]').toggleClass("hidden",!!r.length);const a=x.Dropdown.getInstance(f.find(".dropdown-toggle").get(0));a&&a.update()})}},y}.apply(v,p),C!==void 0&&(k.exports=C)}}]);
