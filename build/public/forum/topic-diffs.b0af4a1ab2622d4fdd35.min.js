"use strict";(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[1091,12533,22765,34271,49897,92747,99127],{2269:(A,k)=>{var u,m;u=[],m=function(){const E={},g=/-resized(\.[\w]+)?$/;return E.wrapImagesInLinks=function(w){w.find('[component="post/content"] img:not(.emoji)').each(function(){E.wrapImageInLink($(this))})},E.wrapImageInLink=function(w){let a=w.attr("src")||"";if(a!=="about:blank"&&!w.parent().is("a")){utils.isRelativeUrl(a)&&g.test(a)&&(a=a.replace(g,"$1"));const o=w.attr("alt")||"",P=a.split(".").slice(1).pop(),C=o.split("/").pop(),n=C.split(".").slice(1).pop();w.wrap('<a href="'+a+'" '+(!P&&n?' download="'+utils.escapeHTML(C)+'" ':"")+' target="_blank" rel="noopener">')}},E}.apply(k,u),m!==void 0&&(A.exports=m)},49897:(A,k,u)=>{u.r(k),u.d(k,{del:()=>i,get:()=>C,head:()=>n,patch:()=>d,post:()=>l,put:()=>s});var m=u(91749),E=u.n(m),g=u(33530),w=u.n(g);const a=config.relative_path+"/api/v3";async function o(e,r){if(e.url=e.url.startsWith("/api")?config.relative_path+e.url:a+e.url,typeof r=="function"){P(e).then(t=>r(null,t),t=>{let h=t;t instanceof Error||(h=new Error(String(t)));const p=h.message||String(h);if(p&&!p.startsWith("[[error:")&&(p.toLowerCase()==="fetch failed"||p.toLowerCase()==="failed to fetch"||p.toLowerCase().includes("networkerror")||p.toLowerCase().includes("network")&&p.toLowerCase().includes("failed"))){const c=new Error("[[error:no-connection]]");c.originalError=h,h=c}r(h)});return}try{return await P(e)}catch(t){if(t.message==="A valid login session was not found. Please log in and try again."){const{url:h}=await(0,m.fire)("filter:admin.reauth",{url:"login"});return(0,g.confirm)("[[error:api.reauth-required]]",p=>{p&&ajaxify.go(h)})}throw t}}async function P(e){const{url:r}=e;delete e.url,e.headers||(e.headers={}),e.data&&!(e.data instanceof FormData)&&(e.data=JSON.stringify(e.data||{}),e.headers["content-type"]="application/json; charset=utf-8");try{({options:e}=await(0,m.fire)("filter:api.options",{options:e}))}catch(f){console.error("[API] Error in filter:api.options hook:",f)}e.data&&(e.body=e.data,delete e.data);let t;try{t=await fetch(r,e)}catch(f){const y=f.message||f.toString()||String(f),D=f.name||"Error";if(D==="TypeError"&&(y.toLowerCase().includes("fetch")||y.toLowerCase().includes("network")||y.toLowerCase().includes("failed to fetch")||y.toLowerCase().includes("load failed"))||y.toLowerCase().includes("cors")||y.toLowerCase().includes("networkerror")){console.error("[API] Network error:",{url:r,method:e.method||"GET",error:y,name:D});const I=new Error("[[error:no-connection]]");throw I.originalError=f,I}throw console.error("[API] Unexpected fetch error:",{url:r,method:e.method||"GET",error:y,name:D}),f}const{headers:h}=t;if(h.get("x-redirect"))return P({url:h.get("x-redirect"),...e});const p=h.get("content-type"),_=p&&p.startsWith("application/json");let c;if(e.method!=="HEAD")try{_?c=await t.json():c=await t.text()}catch(f){throw console.error("[API] Error parsing response:",{url:r,status:t.status,statusText:t.statusText,contentType:p,error:f.message}),new Error("[[error:invalid-json]]")}if(!t.ok){let f;throw c?_&&c.status&&c.status.message?f=c.status.message:typeof c=="string"?f=c:f=t.statusText||"Request failed":f=t.statusText||"Request failed",new Error(f)}return _&&c&&c.hasOwnProperty("status")&&c.hasOwnProperty("response")?c.response:c}function C(e,r,t){return o({url:e+(r&&Object.keys(r).length?"?"+$.param(r):"")},t)}function n(e,r,t){return o({url:e+(r&&Object.keys(r).length?"?"+$.param(r):""),method:"HEAD"},t)}function l(e,r,t){return o({url:e,method:"POST",data:r,headers:{"x-csrf-token":config.csrf_token}},t)}function d(e,r,t){return o({url:e,method:"PATCH",data:r,headers:{"x-csrf-token":config.csrf_token}},t)}function s(e,r,t){return o({url:e,method:"PUT",data:r,headers:{"x-csrf-token":config.csrf_token}},t)}function i(e,r,t){return o({url:e,method:"DELETE",data:r,headers:{"x-csrf-token":config.csrf_token}},t)}},92747:(A,k,u)=>{var m,E;m=[u(49897),u(33530),u(29930),u(2269)],E=function(g,w,a){const o={},P={year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"};o.open=function(n){config.enablePostHistory&&g.get(`/posts/${encodeURIComponent(n)}/diffs`,{}).then(l=>{C(l).then(d=>{const s=w.dialog({title:"[[topic:diffs.title]]",message:d,size:"large",onEscape:!0,backdrop:!0});if(!l.timestamps.length)return;const i=s.find("select"),e=s.find('button[data-action="restore"]'),r=s.find('button[data-action="delete"]'),t=s.find("ul.posts-list"),h=s.find(".number-of-diffs strong");i.on("change",function(){o.load(n,this.value,t),e.prop("disabled",l.timestamps.indexOf(this.value)===0),r.prop("disabled",l.timestamps.indexOf(this.value)===0)}),e.on("click",function(){o.restore(n,i.val(),s)}),r.on("click",function(){o.delete(n,i.val(),i,h)}),s.on("shown.bs.modal",function(){o.load(n,i.val(),t),e.prop("disabled",!0),r.prop("disabled",!0)})})}).catch(a.error)},o.load=function(n,l,d){config.enablePostHistory&&g.get(`/posts/${encodeURIComponent(n)}/diffs/${l}`,{}).then(s=>{s.deleted=!!parseInt(s.deleted,10),app.parseAndTranslate("partials/posts_list","posts",{posts:[s]},function(i){d.empty().append(i),d.find(".timeago").timeago()})}).catch(a.error)},o.restore=function(n,l,d){config.enablePostHistory&&g.put(`/posts/${encodeURIComponent(n)}/diffs/${l}`,{}).then(()=>{d.modal("hide"),a.success("[[topic:diffs.post-restored]]")}).catch(a.error)},o.delete=function(n,l,d,s){g.del(`/posts/${encodeURIComponent(n)}/diffs/${l}`).then(i=>{C(i,"diffs").then(e=>{d.empty().append(e),d.trigger("change");const r=d.find("option").length;s.text(r),a.success("[[topic:diffs.deleted]]")})}).catch(a.error)};function C(n,l){return new Promise(d=>{const s=[{diffs:n.revisions.map(function(i){const e=parseInt(i.timestamp,10);return{username:i.username,timestamp:e,pretty:new Date(e).toLocaleString(config.userLang.replace("_","-"),P)}}),numDiffs:n.timestamps.length,editable:n.editable,deletable:n.deletable},function(i){d(i)}];l&&s.unshift(l),app.parseAndTranslate("modals/post-history",...s)})}return o}.apply(k,m),E!==void 0&&(A.exports=E)}}]);
