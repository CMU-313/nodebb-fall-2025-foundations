"use strict";(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[1091,34271,49897,87358,99127],{49897:(P,p,l)=>{l.r(p),l.d(p,{del:()=>L,get:()=>w,head:()=>y,patch:()=>s,post:()=>n,put:()=>C});var u=l(91749),E=l.n(u),m=l(33530),x=l.n(m);const f=config.relative_path+"/api/v3";async function a(e,r){if(e.url=e.url.startsWith("/api")?config.relative_path+e.url:f+e.url,typeof r=="function"){g(e).then(t=>r(null,t),t=>{let d=t;t instanceof Error||(d=new Error(String(t)));const c=d.message||String(d);if(c&&!c.startsWith("[[error:")&&(c.toLowerCase()==="fetch failed"||c.toLowerCase()==="failed to fetch"||c.toLowerCase().includes("networkerror")||c.toLowerCase().includes("network")&&c.toLowerCase().includes("failed"))){const o=new Error("[[error:no-connection]]");o.originalError=d,d=o}r(d)});return}try{return await g(e)}catch(t){if(t.message==="A valid login session was not found. Please log in and try again."){const{url:d}=await(0,u.fire)("filter:admin.reauth",{url:"login"});return(0,m.confirm)("[[error:api.reauth-required]]",c=>{c&&ajaxify.go(d)})}throw t}}async function g(e){const{url:r}=e;delete e.url,e.headers||(e.headers={}),e.data&&!(e.data instanceof FormData)&&(e.data=JSON.stringify(e.data||{}),e.headers["content-type"]="application/json; charset=utf-8");try{({options:e}=await(0,u.fire)("filter:api.options",{options:e}))}catch(i){console.error("[API] Error in filter:api.options hook:",i)}e.data&&(e.body=e.data,delete e.data);let t;try{t=await fetch(r,e)}catch(i){const h=i.message||i.toString()||String(i),A=i.name||"Error";if(A==="TypeError"&&(h.toLowerCase().includes("fetch")||h.toLowerCase().includes("network")||h.toLowerCase().includes("failed to fetch")||h.toLowerCase().includes("load failed"))||h.toLowerCase().includes("cors")||h.toLowerCase().includes("networkerror")){console.error("[API] Network error:",{url:r,method:e.method||"GET",error:h,name:A});const T=new Error("[[error:no-connection]]");throw T.originalError=i,T}throw console.error("[API] Unexpected fetch error:",{url:r,method:e.method||"GET",error:h,name:A}),i}const{headers:d}=t;if(d.get("x-redirect"))return g({url:d.get("x-redirect"),...e});const c=d.get("content-type"),k=c&&c.startsWith("application/json");let o;if(e.method!=="HEAD")try{k?o=await t.json():o=await t.text()}catch(i){throw console.error("[API] Error parsing response:",{url:r,status:t.status,statusText:t.statusText,contentType:c,error:i.message}),new Error("[[error:invalid-json]]")}if(!t.ok){let i;throw o?k&&o.status&&o.status.message?i=o.status.message:typeof o=="string"?i=o:i=t.statusText||"Request failed":i=t.statusText||"Request failed",new Error(i)}return k&&o&&o.hasOwnProperty("status")&&o.hasOwnProperty("response")?o.response:o}function w(e,r,t){return a({url:e+(r&&Object.keys(r).length?"?"+$.param(r):"")},t)}function y(e,r,t){return a({url:e+(r&&Object.keys(r).length?"?"+$.param(r):""),method:"HEAD"},t)}function n(e,r,t){return a({url:e,method:"POST",data:r,headers:{"x-csrf-token":config.csrf_token}},t)}function s(e,r,t){return a({url:e,method:"PATCH",data:r,headers:{"x-csrf-token":config.csrf_token}},t)}function C(e,r,t){return a({url:e,method:"PUT",data:r,headers:{"x-csrf-token":config.csrf_token}},t)}function L(e,r,t){return a({url:e,method:"DELETE",data:r,headers:{"x-csrf-token":config.csrf_token}},t)}},93230:(P,p,l)=>{var u,E;u=[l(49897),l(29930)],E=function(m,x){const f={};let a;f.init=function(n){a=n,$('[component="chat/pinned/messages/btn"]').on("click",async()=>{const s=a.find('[component="chat/messages/pinned/container"]');if(!s.hasClass("hidden"))return s.addClass("hidden");a.find('[component="chat/user/list"]').addClass("hidden"),await f.refreshList(),s.removeClass("hidden")}),g(a)};function g(n){const s=n.find('[component="chat/messages/pinned"]');s.on("scroll",utils.debounce(async()=>{const C=(s[0].scrollHeight-s.height())*.85;if(s.scrollTop()>C){const L=s.find("[data-index]").last().attr("data-index"),e=await y(parseInt(L,10)+1);if(e&&e.length){const r=await w(e);n.find('[component="chat/messages/pinned"]').append(r)}}},200))}f.refreshList=async function(){const n=await y(0);if(!n.length){a.find('[component="chat/messages/pinned/empty"]').removeClass("hidden"),a.find('[component="chat/messages/pinned"]').html("");return}a.find('[component="chat/messages/pinned/empty"]').addClass("hidden");const s=await w(n);a.find('[component="chat/messages/pinned"]').html(s),s.find(".timeago").timeago()};async function w(n){return await app.parseAndTranslate("partials/chats/pinned-messages-list","messages",{isOwner:ajaxify.data.isOwner,isAdminOrGlobalMod:ajaxify.data.isAdminOrGlobalMod,messages:n})}async function y(n){const{messages:s}=await m.get(`/chats/${ajaxify.data.roomId}/messages/pinned`,{start:n});return s}return f.pin=function(n,s){m.put(`/chats/${s}/messages/${n}/pin`,{}).then(()=>{$(`[component="chat/message"][data-mid="${n}"]`).toggleClass("pinned",!0),f.refreshList()}).catch(x.error)},f.unpin=function(n,s){m.del(`/chats/${s}/messages/${n}/pin`,{}).then(()=>{$(`[component="chat/message"][data-mid="${n}"]`).toggleClass("pinned",!1),a.find(`[component="chat/messages/pinned"] [data-mid="${n}"]`).remove(),a.find('[component="chat/messages/pinned"] [data-mid]').length||a.find('[component="chat/messages/pinned/empty"]').removeClass("hidden")}).catch(x.error)},f}.apply(p,u),E!==void 0&&(P.exports=E)}}]);
