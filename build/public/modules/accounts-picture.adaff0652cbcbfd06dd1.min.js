"use strict";(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[1091,16852,34271,43400,49897,99127],{7524:(D,b,c)=>{var y,x;y=[c(72254),c(49897),c(33530),c(29930)],x=((g,w,v,p)=>{const m={};m.openChangeModal=()=>{socket.emit("user.getProfilePictures",{uid:ajaxify.data.uid},function(a,n){if(a)return p.error(a);const s=n.reduce(function(i,e){return i||e.type==="uploaded"},!1);app.parseAndTranslate("modals/change-picture",{pictures:n,uploaded:s,icon:{text:ajaxify.data["icon:text"],bgColor:ajaxify.data["icon:bgColor"]},defaultAvatar:ajaxify.data.defaultAvatar,allowProfileImageUploads:ajaxify.data.allowProfileImageUploads,iconBackgrounds:ajaxify.data.iconBackgrounds,user:{uid:ajaxify.data.uid,username:ajaxify.data.username,picture:ajaxify.data.picture,"icon:text":ajaxify.data["icon:text"],"icon:bgColor":ajaxify.data["icon:bgColor"]}},function(i){const e=v.dialog({className:"picture-switcher",title:"[[user:change-picture]]",message:i,show:!0,size:"large",buttons:{close:{label:"[[global:close]]",callback:d,className:"btn-link"},update:{label:"[[global:save-changes]]",callback:o}}});e.on("shown.bs.modal",r),e.on("click",".list-group-item",function(){e.find(".list-group-item").removeClass("active"),$(this).addClass("active")}),e.on("click","[data-bg-color]",function(){const l=$(this).attr("data-bg-color");$(this).addClass("selected").siblings().removeClass("selected"),e.find('[component="avatar/icon"]').css("background-color",l)}),t(e);function r(){ajaxify.data.picture?e.find(".list-group-item img").each(function(){this.getAttribute("src")===ajaxify.data.picture&&$(this).parents(".list-group-item").addClass("active")}):e.find('[data-type="default"]').addClass("active");const l=e.find(`[data-bg-color="${ajaxify.data["icon:bgColor"]}"]`);l.length?l.addClass("selected"):e.find('[data-bg-color="transparent"]').addClass("selected")}function o(){const l=e.find(".list-group-item.active").attr("data-type"),E=e.find("[data-bg-color].selected").attr("data-bg-color")||"transparent";h(l,E).then(()=>{m.updateHeader(l==="default"?"":e.find(".list-group-item.active img").attr("src"),E),ajaxify.refresh()}).catch(p.error)}function d(){e.modal("hide")}})})},m.updateHeader=(a,n)=>{if(parseInt(ajaxify.data.theirid,10)!==parseInt(ajaxify.data.yourid,10))return;!a&&ajaxify.data.defaultAvatar&&(a=ajaxify.data.defaultAvatar);const s=$('[component="header/avatar"] [component="avatar/picture"]'),i=$('[component="header/avatar"] [component="avatar/icon"]');if(a){if(!s.length&&i.length){const e=$("<img/>");$(i[0].attributes).each(function(){e.attr(this.nodeName,this.nodeValue)}),e.attr("component","avatar/picture").attr("src",a).insertBefore(i)}}else s.remove();n&&i.css({"background-color":n})};function t(a){function n(i){i=(i.startsWith("http")?"":config.relative_path)+i;const e=i+"?"+Date.now();m.updateHeader(e),ajaxify.data.picture&&ajaxify.data.picture.length?($(`#user-current-picture, img[data-uid="${ajaxify.data.theirid}"].avatar`).attr("src",e),ajaxify.data.uploadedpicture=i,ajaxify.data.picture=i):ajaxify.refresh(function(){$(`#user-current-picture, img[data-uid="${ajaxify.data.theirid}"].avatar`).attr("src",e)})}function s(){ajaxify.data.uploadedpicture===ajaxify.data.picture&&(ajaxify.refresh(),m.updateHeader())}a.find('[data-action="upload"]').on("click",function(){return a.modal("hide"),g.show({socketMethod:"user.uploadCroppedPicture",route:config.relative_path+"/api/user/"+ajaxify.data.userslug+"/uploadpicture",aspectRatio:1/1,paramName:"uid",paramValue:ajaxify.data.theirid,fileSize:ajaxify.data.maximumProfileImageSize,allowSkippingCrop:!1,title:"[[user:upload-picture]]",description:"[[user:upload-a-picture]]",accept:ajaxify.data.allowedProfileImageExtensions},function(i){n(i)}),!1}),a.find('[data-action="upload-url"]').on("click",function(){return a.modal("hide"),app.parseAndTranslate("modals/upload-picture-from-url",{},function(i){i.modal("show"),i.find(".upload-btn").on("click",function(){const e=i.find("#uploadFromUrl").val();return e&&(i.modal("hide"),g.handleImageCrop({url:e,socketMethod:"user.uploadCroppedPicture",aspectRatio:1,allowSkippingCrop:!1,paramName:"uid",paramValue:ajaxify.data.theirid},n)),!1})}),!1}),a.find('[data-action="remove-uploaded"]').on("click",function(){socket.emit("user.removeUploadedPicture",{uid:ajaxify.data.theirid},function(i){if(a.modal("hide"),i)return p.error(i);s()})})}function h(a,n){return w.put(`/users/${ajaxify.data.theirid}/picture`,{type:a,bgColor:n})}return m}).apply(b,y),x!==void 0&&(D.exports=x)},49897:(D,b,c)=>{c.r(b),c.d(b,{del:()=>i,get:()=>t,head:()=>h,patch:()=>n,post:()=>a,put:()=>s});var y=c(91749),x=c.n(y),g=c(33530),w=c.n(g);const v=config.relative_path+"/api/v3";async function p(e,r){if(e.url=e.url.startsWith("/api")?config.relative_path+e.url:v+e.url,typeof r=="function"){m(e).then(o=>r(null,o),o=>{let d=o;o instanceof Error||(d=new Error(String(o)));const l=d.message||String(d);if(l&&!l.startsWith("[[error:")&&(l.toLowerCase()==="fetch failed"||l.toLowerCase()==="failed to fetch"||l.toLowerCase().includes("networkerror")||l.toLowerCase().includes("network")&&l.toLowerCase().includes("failed"))){const u=new Error("[[error:no-connection]]");u.originalError=d,d=u}r(d)});return}try{return await m(e)}catch(o){if(o.message==="A valid login session was not found. Please log in and try again."){const{url:d}=await(0,y.fire)("filter:admin.reauth",{url:"login"});return(0,g.confirm)("[[error:api.reauth-required]]",l=>{l&&ajaxify.go(d)})}throw o}}async function m(e){const{url:r}=e;delete e.url,e.headers||(e.headers={}),e.data&&!(e.data instanceof FormData)&&(e.data=JSON.stringify(e.data||{}),e.headers["content-type"]="application/json; charset=utf-8");try{({options:e}=await(0,y.fire)("filter:api.options",{options:e}))}catch(f){console.error("[API] Error in filter:api.options hook:",f)}e.data&&(e.body=e.data,delete e.data);let o;try{o=await fetch(r,e)}catch(f){const C=f.message||f.toString()||String(f),k=f.name||"Error";if(k==="TypeError"&&(C.toLowerCase().includes("fetch")||C.toLowerCase().includes("network")||C.toLowerCase().includes("failed to fetch")||C.toLowerCase().includes("load failed"))||C.toLowerCase().includes("cors")||C.toLowerCase().includes("networkerror")){console.error("[API] Network error:",{url:r,method:e.method||"GET",error:C,name:k});const A=new Error("[[error:no-connection]]");throw A.originalError=f,A}throw console.error("[API] Unexpected fetch error:",{url:r,method:e.method||"GET",error:C,name:k}),f}const{headers:d}=o;if(d.get("x-redirect"))return m({url:d.get("x-redirect"),...e});const l=d.get("content-type"),E=l&&l.startsWith("application/json");let u;if(e.method!=="HEAD")try{E?u=await o.json():u=await o.text()}catch(f){throw console.error("[API] Error parsing response:",{url:r,status:o.status,statusText:o.statusText,contentType:l,error:f.message}),new Error("[[error:invalid-json]]")}if(!o.ok){let f;throw u?E&&u.status&&u.status.message?f=u.status.message:typeof u=="string"?f=u:f=o.statusText||"Request failed":f=o.statusText||"Request failed",new Error(f)}return E&&u&&u.hasOwnProperty("status")&&u.hasOwnProperty("response")?u.response:u}function t(e,r,o){return p({url:e+(r&&Object.keys(r).length?"?"+$.param(r):"")},o)}function h(e,r,o){return p({url:e+(r&&Object.keys(r).length?"?"+$.param(r):""),method:"HEAD"},o)}function a(e,r,o){return p({url:e,method:"POST",data:r,headers:{"x-csrf-token":config.csrf_token}},o)}function n(e,r,o){return p({url:e,method:"PATCH",data:r,headers:{"x-csrf-token":config.csrf_token}},o)}function s(e,r,o){return p({url:e,method:"PUT",data:r,headers:{"x-csrf-token":config.csrf_token}},o)}function i(e,r,o){return p({url:e,method:"DELETE",data:r,headers:{"x-csrf-token":config.csrf_token}},o)}},72254:(D,b,c)=>{var y,x;y=[c(29930)],x=function(g){const w={};w.show=function(t,h){const a=t.hasOwnProperty("fileSize")&&t.fileSize!==void 0?parseInt(t.fileSize,10):!1;app.parseAndTranslate("modals/upload-file",{showHelp:t.hasOwnProperty("showHelp")&&t.showHelp!==void 0?t.showHelp:!0,fileSize:a,title:t.title||"[[global:upload-file]]",description:t.description||"",button:t.button||"[[global:upload]]",accept:t.accept?t.accept.replace(/,/g,"&#44; "):""},function(n){n.modal("show"),n.on("hidden.bs.modal",function(){n.remove()});const s=n.find("#uploadForm");t.route&&s.attr("action",t.route),n.find("#fileUploadSubmitBtn").on("click",function(){return $(this).addClass("disabled"),t.uploadModal=n,m(t,h),!1})})},w.handleImageCrop=function(t,h){$("#crop-picture-modal").remove(),app.parseAndTranslate("modals/crop_picture",{url:utils.escapeHTML(t.url)},async function(a){a.modal({backdrop:"static"}).modal("show");const n=parseInt($(window).height()/2,10),s=document.getElementById("cropped-image");$(s).css("max-height",n);const i=(await c.e(60239).then(c.t.bind(c,65643,23))).default;let e=new i(s,{aspectRatio:t.aspectRatio,autoCropArea:1,viewMode:1,checkCrossOrigin:!0,cropmove:function(){t.restrictImageDimension&&(e.cropBoxData.width>t.imageDimension&&e.setCropBoxData({width:t.imageDimension}),e.cropBoxData.height>t.imageDimension&&e.setCropBoxData({height:t.imageDimension}))},ready:function(){if(!p(e,t))return a.modal("hide");if(t.restrictImageDimension){const r=s.width<s.height?s.width:s.height,o=r>t.imageDimension?t.imageDimension:r;e.setCropBoxData({width:o,height:o})}a.find(".rotate").on("click",function(){const r=this.getAttribute("data-degrees");e.rotate(r)}),a.find(".flip").on("click",function(){const r=this.getAttribute("data-option");this.getAttribute("data-method")==="scaleX"?e.scaleX(r):e.scaleY(r),this.setAttribute("data-option",r*-1)}),a.find(".reset").on("click",function(){e.reset()}),a.find(".crop-btn").on("click",function(){$(this).addClass("disabled");const r=p(e,t);r&&(a.find("#upload-progress-bar").css("width","0%"),a.find("#upload-progress-box").show().removeClass("hide"),v({data:t,imageData:r,progressBarEl:a.find("#upload-progress-bar")},function(o,d){if(o)return a.find("#upload-progress-box").hide(),a.find(".upload-btn").removeClass("disabled"),a.find(".crop-btn").removeClass("disabled"),g.error(o);h(d.url),a.modal("hide")}))}),a.find(".upload-btn").on("click",async function(){$(this).addClass("disabled"),e.destroy();const r=(await c.e(60239).then(c.t.bind(c,65643,23))).default;e=new r(s,{viewMode:1,autoCropArea:1,ready:function(){a.find(".crop-btn").trigger("click")}})})}})})};function v(t,h){const a={};a[t.data.paramName]=t.data.paramValue,a.method=t.data.socketMethod,a.size=t.imageData.length,a.progress=0;const n=1e5;function s(){const i=t.imageData.slice(a.progress,a.progress+n);socket.emit("uploads.upload",{chunk:i,params:a},function(e,r){if(e)return g.error(e);if(a.progress+n<a.size)return a.progress+=i.length,t.progressBarEl.css("width",(a.progress/a.size*100).toFixed(2)+"%"),setTimeout(s,100);t.progressBarEl.css("width","100%"),h(null,r)})}s()}function p(t,h){let a;try{a=h.imageType?t.getCroppedCanvas().toDataURL(h.imageType):t.getCroppedCanvas().toDataURL()}catch(n){["The operation is insecure.","Failed to execute 'toDataURL' on 'HTMLCanvasElement': Tainted canvases may not be exported."].indexOf(n.message)!==-1?g.error("[[error:cors-error]]"):g.error(n.message);return}return a}function m(t,h){function a(r,o){r==="error"&&t.uploadModal.find("#fileUploadSubmitBtn").removeClass("disabled"),t.uploadModal.find("#alert-"+r).translateText(o).removeClass("hide")}const n=t.uploadModal.find("#fileInput");if(!n.val())return a("error","[[uploads:select-file-to-upload]]");const s=n[0].files[0],i=t.hasOwnProperty("fileSize")&&t.fileSize!==void 0?parseInt(t.fileSize,10):!1;if(i&&s.size>i*1024)return a("error","[[error:file-too-big, "+i+"]]");if(s.name.endsWith(".gif")){c.e(98463).then(function(){var r=[c(24187)];(function(o){o.ajaxSubmit(t.uploadModal,h)}).apply(null,r)}).catch(c.oe);return}const e=new FileReader;e.addEventListener("load",function(){const r=e.result;t.uploadModal.modal("hide"),w.handleImageCrop({url:r,imageType:s.type,socketMethod:t.socketMethod,aspectRatio:t.aspectRatio,allowSkippingCrop:t.allowSkippingCrop,restrictImageDimension:t.restrictImageDimension,imageDimension:t.imageDimension,paramName:t.paramName,paramValue:t.paramValue},h)},!1),s&&e.readAsDataURL(s)}return w}.apply(b,y),x!==void 0&&(D.exports=x)}}]);
