"use strict";(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[1091,18470,34271,49897,89379,99127],{27693:(D,x,f)=>{var A,w;A=[f(70012),f(57576),f(33530),f(81335),f(49897),f(29930)],w=function(P,C,E,p,h,u){const g={};g.init=function(){P.load("core.api",$(".core-api-settings")),$("#save").on("click",()=>{P.save("core.api",$(".core-api-settings"))});const n=document.querySelectorAll('[data-component="acp/tokens"] [data-action="copy"]');new C(n),$('[data-action="create"]').on("click",e),t()};function t(){const n=document.querySelector("#content form");n&&n.addEventListener("click",s=>{const i=s.target.closest("[data-action]");if(i)switch(i.getAttribute("data-action")){case"edit":a(i);break;case"delete":r(i);break;case"roll":o(i);break}})}async function e(){const n=await p.render("admin/partials/edit-token-modal",{}),s=async function(){const i=this,c=this.get(0).querySelector("form"),l=document.querySelector('[data-component="acp/tokens"] tbody'),d=c.reportValidity();if(c&&d){const m=new FormData(c),y=m.get("uid"),k=m.get("description");try{const R=await h.post("/admin/tokens",{uid:y,description:k});if(!l)return i.modal("hide"),ajaxify.refresh();ajaxify.data.tokens.push(R);const T=(await app.parseAndTranslate(ajaxify.data.template.name,"tokens",{tokens:[R]})).get(0);l.append(T),$(T).find(".timeago").timeago(),i.modal("hide")}catch(R){u.error(R)}}return!1};E.dialog({title:"[[admin/settings/api:create-token]]",message:n,buttons:{submit:{label:"[[modules:bootbox.submit]]",className:"btn-primary",callback:s}}})}async function a(n){const s=n.closest("[data-token]"),i=s.getAttribute("data-token"),{uid:c,description:l}=await h.get(`/admin/tokens/${i}`),d=async function(){const y=this,k=this.get(0).querySelector("form"),R=k.reportValidity();if(k&&R){const T=new FormData(k),L=T.get("uid"),O=T.get("description");try{const S=await h.put(`/admin/tokens/${i}`,{uid:L,description:O}),v=(await app.parseAndTranslate(ajaxify.data.template.name,"tokens",{tokens:[S]})).get(0);s.replaceWith(v),$(v).find(".timeago").timeago(),y.modal("hide")}catch(S){u.error(S)}}return!1},m=await p.render("admin/partials/edit-token-modal",{uid:c,description:l});E.dialog({title:"[[admin/settings/api:update-token]]",message:m,buttons:{submit:{label:"[[modules:bootbox.submit]]",className:"btn-primary",callback:d}}})}async function r(n){const s=n.closest("[data-token]"),i=s.getAttribute("data-token");E.confirm("[[admin/settings/api:delete-confirm]]",async c=>{if(c){try{await h.del(`/admin/tokens/${i}`)}catch(l){u.error(l)}s.remove()}})}async function o(n){const s=n.closest("[data-token]"),i=s.getAttribute("data-token");E.confirm("[[admin/settings/api:roll-confirm]]",async c=>{if(c)try{const l=await h.post(`/admin/tokens/${i}/roll`),d=(await app.parseAndTranslate(ajaxify.data.template.name,"tokens",{tokens:[l]})).get(0);s.replaceWith(d),$(d).find(".timeago").timeago()}catch(l){u.error(l)}})}return g}.apply(x,A),w!==void 0&&(D.exports=w)},49897:(D,x,f)=>{f.r(x),f.d(x,{del:()=>r,get:()=>u,head:()=>g,patch:()=>e,post:()=>t,put:()=>a});var A=f(91749),w=f.n(A),P=f(33530),C=f.n(P);const E=config.relative_path+"/api/v3";async function p(o,n){if(o.url=o.url.startsWith("/api")?config.relative_path+o.url:E+o.url,typeof n=="function"){h(o).then(s=>n(null,s),s=>{let i=s;s instanceof Error||(i=new Error(String(s)));const c=i.message||String(i);if(c&&!c.startsWith("[[error:")&&(c.toLowerCase()==="fetch failed"||c.toLowerCase()==="failed to fetch"||c.toLowerCase().includes("networkerror")||c.toLowerCase().includes("network")&&c.toLowerCase().includes("failed"))){const d=new Error("[[error:no-connection]]");d.originalError=i,i=d}n(i)});return}try{return await h(o)}catch(s){if(s.message==="A valid login session was not found. Please log in and try again."){const{url:i}=await(0,A.fire)("filter:admin.reauth",{url:"login"});return(0,P.confirm)("[[error:api.reauth-required]]",c=>{c&&ajaxify.go(i)})}throw s}}async function h(o){const{url:n}=o;delete o.url,o.headers||(o.headers={}),o.data&&!(o.data instanceof FormData)&&(o.data=JSON.stringify(o.data||{}),o.headers["content-type"]="application/json; charset=utf-8");try{({options:o}=await(0,A.fire)("filter:api.options",{options:o}))}catch(m){console.error("[API] Error in filter:api.options hook:",m)}o.data&&(o.body=o.data,delete o.data);let s;try{s=await fetch(n,o)}catch(m){const y=m.message||m.toString()||String(m),k=m.name||"Error";if(k==="TypeError"&&(y.toLowerCase().includes("fetch")||y.toLowerCase().includes("network")||y.toLowerCase().includes("failed to fetch")||y.toLowerCase().includes("load failed"))||y.toLowerCase().includes("cors")||y.toLowerCase().includes("networkerror")){console.error("[API] Network error:",{url:n,method:o.method||"GET",error:y,name:k});const T=new Error("[[error:no-connection]]");throw T.originalError=m,T}throw console.error("[API] Unexpected fetch error:",{url:n,method:o.method||"GET",error:y,name:k}),m}const{headers:i}=s;if(i.get("x-redirect"))return h({url:i.get("x-redirect"),...o});const c=i.get("content-type"),l=c&&c.startsWith("application/json");let d;if(o.method!=="HEAD")try{l?d=await s.json():d=await s.text()}catch(m){throw console.error("[API] Error parsing response:",{url:n,status:s.status,statusText:s.statusText,contentType:c,error:m.message}),new Error("[[error:invalid-json]]")}if(!s.ok){let m;throw d?l&&d.status&&d.status.message?m=d.status.message:typeof d=="string"?m=d:m=s.statusText||"Request failed":m=s.statusText||"Request failed",new Error(m)}return l&&d&&d.hasOwnProperty("status")&&d.hasOwnProperty("response")?d.response:d}function u(o,n,s){return p({url:o+(n&&Object.keys(n).length?"?"+$.param(n):"")},s)}function g(o,n,s){return p({url:o+(n&&Object.keys(n).length?"?"+$.param(n):""),method:"HEAD"},s)}function t(o,n,s){return p({url:o,method:"POST",data:n,headers:{"x-csrf-token":config.csrf_token}},s)}function e(o,n,s){return p({url:o,method:"PATCH",data:n,headers:{"x-csrf-token":config.csrf_token}},s)}function a(o,n,s){return p({url:o,method:"PUT",data:n,headers:{"x-csrf-token":config.csrf_token}},s)}function r(o,n,s){return p({url:o,method:"DELETE",data:n,headers:{"x-csrf-token":config.csrf_token}},s)}},70012:(D,x,f)=>{var A,w;A=[f(91749),f(29930)],w=function(P,C){let E=[],p=0;function h(t,e){typeof t!="string"&&(t=$(t),t=t.data("type")||t.attr("type")||t.prop("tagName"));const a=g.plugins[t.toLowerCase()];if(a==null)return;const r=a[e];return typeof r=="function"?r:null}const u={deepClone:function(t){return typeof t=="object"?JSON.parse(JSON.stringify(t)):t},createElement:function(t,e,a){const r=document.createElement(t);for(const[o,n]of Object.entries(e))r.setAttribute(o,n);return a&&r.appendChild(document.createTextNode(a)),r},initElement:function(t){const e=h(t,"init");e?.call(g,$(t))},destructElement:function(t){const e=h(t,"destruct");e?.call(g,$(t))},createElementOfType:function(t,e,a){let r;const o=h(t,"create");return o!=null?r=$(o.call(g,t,e,a)):(a==null&&(a={}),t!=null&&(a.type=t),r=$(u.createElement(e||"input",a))),r.data("type",t),u.initElement(r),r},cleanArray:function(t,e,a){const r=[];if(!e&&a)return t;for(let o=0;o<t.length;o+=1){let n=t[o];e&&(n===!!n?n=+n:n&&typeof n.trim=="function"&&(n=n.trim())),(a||n!=null&&n.length)&&r.push(n)}return r},isTrue:function(t){return t==="true"||+t==1},isFalse:function(t){return t==="false"||+t==0},readValue:function(t){let e=!u.isFalse(t.data("empty"));const a=!u.isFalse(t.data("trim")),r=t.data("split"),o=h(t,"get");let n;if(o!=null)return o.call(g,t,a,e);if(r!=null){e=u.isTrue(t.data("empty")),n=t.val();const s=n!=null&&n.split(r||",")||[];return u.cleanArray(s,a,e)}if(n=t.val(),a&&n!=null&&typeof n.trim=="function"&&(n=n.trim()),e||n!==void 0&&(n==null||n.length!==0))return n},fillField:function(t,e){const a=h(t,"set");let r=t.data("trim");if(r=r!=="false"&&+r!=0,a!=null)return a.call(g,t,e,r);e instanceof Array&&(e=e.join(t.data("split")||(r?", ":","))),r&&e&&typeof e.trim=="function"?(e=e.trim(),typeof e.toString=="function"&&(e=e.toString())):e!=null?(typeof e.toString=="function"&&(e=e.toString()),r&&(e=e.trim())):e="",e!==void 0&&t.val(e)},initFields:function(t){$("[data-key]",t).each(function(e,a){a=$(a);const r=h(a,"init"),o=a.data("key").split(".");let n=g.get();r?.call(g,a);for(let s=0;s<o.length;s+=1){const i=o[s];i&&n!=null&&(n=n[i])}u.fillField(a,n)})},registerReadyJobs:function(t){return p+=t,p},beforeReadyJobsDecreased:function(t){if(t==null&&(t=1),p>0&&(p-=t,p<=0)){for(let e=0;e<E.length;e+=1)E[e]();E=[]}},whenReady:function(t){p<=0?t():E.push(t)},serializeForm:function(t){const e=t.serializeObject();return t.find('input[type="checkbox"]').each(function(a,r){r=$(r),r.is(":checked")||(e[r.attr("name")]="off")}),t.find("select[multiple]").each(function(a,r){r=$(r),e[r.attr("name")]=JSON.stringify(r.val())}),e},persistSettings:function(t,e,a,r){e!=null&&e._!=null&&typeof e._!="string"&&(e=u.deepClone(e),e._=JSON.stringify(e._)),socket.emit("admin.settings.set",{hash:t,values:e},function(o){a&&(o?C.alert({title:"[[admin/admin:changes-not-saved]]",type:"danger",message:`[[admin/admin/changes-not-saved-message, ${o.message}]]`,timeout:5e3}):C.alert({title:"[[admin/admin:changes-saved]]",type:"success",message:"[[admin/admin:changes-saved-message]]",timeout:2500})),typeof r=="function"&&r(o)})},use:function(t){try{t._=JSON.parse(t._)}catch(e){console.error(e)}g.cfg=t}},g={helper:u,plugins:{},cfg:{},get:function(){return g.cfg!=null&&g.cfg._!==void 0?g.cfg._:g.cfg},registerPlugin:function(t,e){e==null?e=t.types:t.types=e,typeof t.use=="function"&&t.use.call(g);for(let a=0;a<e.length;a+=1){const r=e[a].toLowerCase();g.plugins[r]==null&&(g.plugins[r]=t)}},set:function(t,e,a,r,o){o==null&&(o=!0),u.whenReady(function(){u.use(e),u.initFields(a||"form"),u.persistSettings(t,e,o,r)})},sync:function(t,e,a){socket.emit("admin.settings.get",{hash:t},function(r,o){r?typeof a=="function"&&a(r):u.whenReady(function(){u.use(o),u.initFields(e||"form"),typeof a=="function"&&a()})})},persist:function(t,e,a,r){const o=[],n=$("[data-key]",e||"form").toArray();r==null&&(r=!0);for(let s=0;s<n.length;s+=1){const i=$(n[s]),c=u.readValue(i);let l=g.get();const d=i.data("key").split("."),m=d[d.length-1];if(d.length>1)for(let y=0;y<d.length-1;y+=1){const k=d[y];k&&l!=null&&(l=l[k])}l!=null?c!=null?l[m]=c:delete l[m]:o.push(i.data("key"))}o.length&&C.alert({title:"Attributes Not Saved",message:"'"+o.join(", ")+"' could not be saved. Please contact the plugin-author!",type:"danger",timeout:5e3}),u.persistSettings(t,g.cfg,r,a)},load:function(t,e,a){a=a||function(){};const r=e.attr("data-socket-get");socket.emit(r||"admin.settings.get",{hash:t},function(o,n){if(o)return a(o);$(e).find("select[multiple]").each(function(i,c){const l=$(c).attr("name");if(l&&n.hasOwnProperty(l))try{n[l]=JSON.parse(n[l])}catch(d){console.error(d)}}),ajaxify.data[r?t:"settings"]=n,u.whenReady(function(){$(e).find("[data-sorted-list]").each(function(i,c){h(c,"get").call(g,$(c),t)})}),$(e).deserialize(n),P.fire("action:admin.settingsLoaded"),$(e).on("change","input, select, textarea",function(){app.flags=app.flags||{},app.flags._unsaved=!0});const s=document.getElementById("save");s&&f.e(6411).then(function(){var i=[f(6411)];(function(c){c.bind("ctrl+s",function(l){s.click(),l.preventDefault()})}).apply(null,i)}).catch(f.oe),a(null,n)})},save:function(t,e,a){e=$(e);const r=e.get(0).elements;if(g.check(r)&&e.length){const n=u.serializeForm(e);u.whenReady(function(){const i=e.find("[data-sorted-list]");i.length&&i.each((c,l)=>{h(l,"set").call(g,$(l),n)})});const s=e.attr("data-socket-set");socket.emit(s||"admin.settings.set",{hash:t,values:n},function(i){if(app.flags._unsaved=!1,ajaxify.data[s?t:"settings"]=n,typeof a=="function")a(i);else if(i)C.alert({title:"[[admin/admin:changes-not-saved]]",message:`[[admin/admin:changes-not-saved-message, ${i.message}]]`,type:"error",timeout:2500});else{const c=document.getElementById("save");c.classList.toggle("saved",!0),setTimeout(()=>{c.classList.toggle("saved",!1)},1500)}})}},check:function(t){const e=a=>{const r=a.target.closest(".form-group");r&&r.classList.add("has-error"),a.target.removeEventListener("invalid",e)};return Array.prototype.map.call(t,a=>{const r=a.closest(".form-group");return r&&r.classList.remove("has-error"),a.addEventListener("invalid",e),a.reportValidity()}).every(Boolean)}};return u.registerReadyJobs(1),Promise.all([f.e(23662),f.e(65285),f.e(19308)]).then(function(){var t=[f(75210),f(474),f(50397),f(71575),f(40054),f(17708),f(46700),f(59175)];(function(){for(let e=0;e<arguments.length;e+=1)g.registerPlugin(arguments[e]);u.beforeReadyJobsDecreased()}).apply(null,t)}).catch(f.oe),g}.apply(x,A),w!==void 0&&(D.exports=w)}}]);
