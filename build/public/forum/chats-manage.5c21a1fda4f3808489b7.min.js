"use strict";(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[1091,13417,34271,34405,49897,56227,62010,99127],{34405:(k,C,d)=>{var A,x;A=[d(49897),d(29930),d(36e3),d(9787),d(35786)],x=function(m,y,{Textcomplete:w},{TextareaEditor:T},{ContenteditableEditor:v}){const g={},p={delay:200,appendTo:null};g.init=o=>{const a={...p,...o},{input:r,onSelect:t}=a;app.loadJQueryUI(function(){r.autocomplete({...a,open:function(){$(this).autocomplete("widget").css("z-index",100005)},select:function(e,n){i(r,t,e,n)}})})},g.user=function(o,a,r){typeof a=="function"&&(r=a,a={}),a=a||{},g.init({input:o,onSelect:r,source:(t,e)=>{a.query=t.term,m.get("/api/users",a,function(n,u){if(n)return y.error(n);if(u&&u.users){const c=u.users.map(function(f){const l=$("<div></div>").html(f.username).text();return f&&{label:l,value:l,user:{uid:f.uid,name:f.username,slug:f.userslug,username:f.username,userslug:f.userslug,displayname:f.displayname,picture:f.picture,banned:f.banned,"icon:text":f["icon:text"],"icon:bgColor":f["icon:bgColor"]}}});e(c)}$(".ui-autocomplete a").attr("data-ajaxify","false")})}})},g.group=function(o,a){g.init({input:o,onSelect:a,source:(r,t)=>{socket.emit("groups.search",{query:r.term},function(e,n){if(e)return y.error(e);if(n&&n.length){const u=n.map(function(c){return c&&{label:c.name,value:c.name,group:c}});t(u)}$(".ui-autocomplete a").attr("data-ajaxify","false")})}})},g.tag=function(o,a){g.init({input:o,onSelect:a,delay:100,source:(r,t)=>{socket.emit("topics.autocompleteTags",{query:r.term,cid:ajaxify.data.cid||0},function(e,n){if(e)return y.error(e);n&&t(n),$(".ui-autocomplete a").attr("data-ajaxify","false")})}})};function i(o,a,r,t){a=a||function(){};const e=jQuery.Event("keypress");e.which=13,e.keyCode=13,setTimeout(function(){o.trigger(e)},100),a(r,t)}return g.setup=function({element:o,strategies:a,options:r}){const t=o.get(0);if(t){var e;if(t.nodeName==="TEXTAREA"||t.nodeName==="INPUT"?e=new T(t):t.nodeName==="DIV"&&t.getAttribute("contenteditable")==="true"&&(e=new v(t)),!e)throw new Error("unknown target element type");t.setAttribute("dir",document.querySelector("html").getAttribute("data-dir"));var n=new w(e,a,{dropdown:r});return n.on("rendered",function(){n.dropdown.items.length&&n.dropdown.items[0].activate()}),n}},g}.apply(C,A),x!==void 0&&(k.exports=x)},49897:(k,C,d)=>{d.r(C),d.d(C,{del:()=>r,get:()=>g,head:()=>p,patch:()=>o,post:()=>i,put:()=>a});var A=d(91749),x=d.n(A),m=d(33530),y=d.n(m);const w=config.relative_path+"/api/v3";async function T(t,e){if(t.url=t.url.startsWith("/api")?config.relative_path+t.url:w+t.url,typeof e=="function"){v(t).then(n=>e(null,n),n=>{let u=n;n instanceof Error||(u=new Error(String(n)));const c=u.message||String(u);if(c&&!c.startsWith("[[error:")&&(c.toLowerCase()==="fetch failed"||c.toLowerCase()==="failed to fetch"||c.toLowerCase().includes("networkerror")||c.toLowerCase().includes("network")&&c.toLowerCase().includes("failed"))){const l=new Error("[[error:no-connection]]");l.originalError=u,u=l}e(u)});return}try{return await v(t)}catch(n){if(n.message==="A valid login session was not found. Please log in and try again."){const{url:u}=await(0,A.fire)("filter:admin.reauth",{url:"login"});return(0,m.confirm)("[[error:api.reauth-required]]",c=>{c&&ajaxify.go(u)})}throw n}}async function v(t){const{url:e}=t;delete t.url,t.headers||(t.headers={}),t.data&&!(t.data instanceof FormData)&&(t.data=JSON.stringify(t.data||{}),t.headers["content-type"]="application/json; charset=utf-8");try{({options:t}=await(0,A.fire)("filter:api.options",{options:t}))}catch(s){console.error("[API] Error in filter:api.options hook:",s)}t.data&&(t.body=t.data,delete t.data);let n;try{n=await fetch(e,t)}catch(s){const h=s.message||s.toString()||String(s),E=s.name||"Error";if(E==="TypeError"&&(h.toLowerCase().includes("fetch")||h.toLowerCase().includes("network")||h.toLowerCase().includes("failed to fetch")||h.toLowerCase().includes("load failed"))||h.toLowerCase().includes("cors")||h.toLowerCase().includes("networkerror")){console.error("[API] Network error:",{url:e,method:t.method||"GET",error:h,name:E});const b=new Error("[[error:no-connection]]");throw b.originalError=s,b}throw console.error("[API] Unexpected fetch error:",{url:e,method:t.method||"GET",error:h,name:E}),s}const{headers:u}=n;if(u.get("x-redirect"))return v({url:u.get("x-redirect"),...t});const c=u.get("content-type"),f=c&&c.startsWith("application/json");let l;if(t.method!=="HEAD")try{f?l=await n.json():l=await n.text()}catch(s){throw console.error("[API] Error parsing response:",{url:e,status:n.status,statusText:n.statusText,contentType:c,error:s.message}),new Error("[[error:invalid-json]]")}if(!n.ok){let s;throw l?f&&l.status&&l.status.message?s=l.status.message:typeof l=="string"?s=l:s=n.statusText||"Request failed":s=n.statusText||"Request failed",new Error(s)}return f&&l&&l.hasOwnProperty("status")&&l.hasOwnProperty("response")?l.response:l}function g(t,e,n){return T({url:t+(e&&Object.keys(e).length?"?"+$.param(e):"")},n)}function p(t,e,n){return T({url:t+(e&&Object.keys(e).length?"?"+$.param(e):""),method:"HEAD"},n)}function i(t,e,n){return T({url:t,method:"POST",data:e,headers:{"x-csrf-token":config.csrf_token}},n)}function o(t,e,n){return T({url:t,method:"PATCH",data:e,headers:{"x-csrf-token":config.csrf_token}},n)}function a(t,e,n){return T({url:t,method:"PUT",data:e,headers:{"x-csrf-token":config.csrf_token}},n)}function r(t,e,n){return T({url:t,method:"DELETE",data:e,headers:{"x-csrf-token":config.csrf_token}},n)}},58836:(k,C,d)=>{var A,x;A=[d(49897),d(29930),d(17459),d(34405),d(72513)],x=function(m,y,w,T,v){const g={};g.init=function(a,r){let t;r.on("click",async function(){let e=[];app.user.isAdmin&&({groups:e}=await m.get("/admin/groups"),e.sort((s,h)=>h.system-s.system).map(s=>{const{name:h,displayName:E}=s;return{name:h,displayName:E}}),Array.isArray(ajaxify.data.groups)&&e.forEach(s=>{s.selected=ajaxify.data.groups.includes(s.name)}));const n=await app.parseAndTranslate("modals/manage-room",{groups:e,user:app.user,room:ajaxify.data});t=bootbox.dialog({title:"[[modules:chat.manage-room]]",size:"large",message:n,onEscape:!0}),t.attr("component","chat/manage-modal"),o(a,t),p(a,t),i(a,t);const u=t.find('[component="chat/manage/user/list"]'),c=t.find('[component="chat/manage/user/list/search"]');v.addSearchHandler(a,c,async s=>{c.val()?u.html(await app.parseAndTranslate("partials/chats/manage-room-users",s)):o(a,t)}),v.addInfiniteScrollHandler(a,u,async(s,h)=>{s.append(await app.parseAndTranslate("partials/chats/manage-room-users",h))});const f=t.find('[component="chat/manage/user/add/search"]'),l=t.find(".text-danger");T.user(f,function(s,h){l.text(""),m.post(`/chats/${a}/users`,{uids:[h.item.user.uid]}).then(E=>{o(a,t,E),f.val("")}).catch(E=>{w.translate(E.message,function(P){l.text(P)})})}),t.find('[component="chat/manage/save"]').on("click",()=>{const s=t.find('[component="chat/room/notification/setting"]');m.put(`/chats/${a}`,{groups:t.find('[component="chat/room/groups"]').val(),notificationSetting:s.val()}).then(h=>{ajaxify.data.groups=h.groups,ajaxify.data.notificationSetting=h.notificationSetting;const E=h.notificationOptions[0];$('[component="chat/notification/setting"] [data-icon]').first().attr("data-icon",E.icon),$('[component="chat/notification/setting/sub-label"]').translateText(E.subLabel),E.selected&&$('[component="chat/notification/setting/icon"]').attr("class",`fa ${E.icon}`),t.modal("hide")}).catch(y.error)})})};function p(a,r){r.on("click",'[data-action="kick"]',function(){const t=encodeURIComponent(this.getAttribute("data-uid"));m.del(`/chats/${a}/users/${t}`,{}).then(e=>{o(a,r,e)}).catch(y.error)})}function i(a,r){r.on("click",'[data-action="toggleOwner"]',async function(){const t=String(this.getAttribute("data-uid")),e=r.get(0).querySelector(`[component="chat/manage/user/list"] > [data-uid="${t}"] [component="chat/manage/user/owner/icon"]`),n=!e.classList.contains("hidden");if(!utils.isNumber(t))return y.error("[[error:invalid-uid]]");await m[n?"del":"put"](`/chats/${a}/owners/${t}`),e.classList.toggle("hidden")})}async function o(a,r,t){const e=r.find('[component="chat/manage/user/list"]');if(!t)try{t=await m.get(`/chats/${a}/users`,{})}catch(n){console.error(n),e.find("li").text(await w.translate("[[error:invalid-data]]"))}e.find('[data-bs-toggle="tooltip"]').tooltip("dispose"),e.html(await app.parseAndTranslate("partials/chats/manage-room-users",t)),e.find('[data-bs-toggle="tooltip"]').tooltip()}return g}.apply(C,A),x!==void 0&&(k.exports=x)},72513:(k,C,d)=>{var A,x;A=[d(49897)],x=function(m){const y={};let w=0;y.init=function(p,i){const o=i.find('[component="chat/user/list"]');if(!o.length)return;const a=i.find('[component="chat/messages/pinned/container"]');i.find('[component="chat/user/list/btn"]').on("click",()=>{o.toggleClass("hidden"),o.hasClass("hidden")?v():(a.addClass("hidden"),T(p,o))}),$(window).off("action:ajaxify.start",v).one("action:ajaxify.start",v),y.addInfiniteScrollHandler(p,o,async(r,t)=>{r.append(await app.parseAndTranslate("partials/chats/user-list","users",t))})};function T(p,i){w&&clearInterval(w),w=setInterval(()=>{g(p,i)},5e3)}function v(){w&&(clearInterval(w),w=0)}async function g(p,i){if(ajaxify.data.template.chats&&app.isFocused&&i.scrollTop()===0&&!i.hasClass("hidden")){const o=await m.get(`/chats/${p}/users`,{start:0});i.find('[data-bs-toggle="tooltip"]').tooltip("dispose"),i.html(await app.parseAndTranslate("partials/chats/user-list","users",o)),i.find('[data-bs-toggle="tooltip"]').tooltip()}}return y.addInfiniteScrollHandler=function(p,i,o){i.on("scroll",utils.debounce(async()=>{const a=(i[0].scrollHeight-i.height())*.85;if(i.scrollTop()>a){const r=i.find("[data-index]").last().attr("data-index"),t=await m.get(`/chats/${p}/users`,{start:parseInt(r,10)+1});t&&t.users.length&&o(i,t)}},200))},y.addSearchHandler=function(p,i,o){i.on("keyup",utils.debounce(async()=>{const a=i.val(),r=await m.get(`/search/chats/${p}/users`,{query:a});o(r)},200))},y}.apply(C,A),x!==void 0&&(k.exports=x)}}]);
