(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[1091,34271,49897,52185,74566,92332,99127],{12236:(S,v,a)=>{"use strict";var h,w;h=[a(49897),a(29930)],w=function(y,A){const i={};i.init=function(e,r){const o=e.find(".draft-icon"),t=e.attr("data-uuid");function n(){$(`[component="composer"][data-uuid="${t}"]`).length&&(r.save_id||(r.save_id=utils.generateSaveId(app.user.uid)),i.addToDraftList("available",r.save_id),i.addToDraftList("open",r.save_id),O(e,o,r))}e.on("keyup","textarea, input.handle, input.title",utils.debounce(n,1e3)),e.on("click",'input[type="checkbox"]',utils.debounce(n,1e3)),e.on("click",'[component="category/list"] [data-cid]',utils.debounce(n,1e3)),e.on("itemAdded",".tags",utils.debounce(n,1e3)),e.on("thumb.uploaded",n),o.on("animationend",function(){$(this).toggleClass("active",!1)}),$(window).on("unload",function(){const s=i.getList("open");s.length&&s.forEach(c=>i.removeFromDraftList("open",c))}),i.migrateGuest(),i.migrateThumbs(...arguments)};function m(e){return parseInt(e,10)>0?localStorage:sessionStorage}i.get=function(e){if(!e)return null;const r=e.split(":")[1],o=m(r);try{const t=o.getItem(e),n=JSON.parse(t)||null;if(!n)throw new Error(`can't parse draft json for ${e}`);return n.save_id=e,n.timestamp&&(n.timestampISO=utils.toISOString(n.timestamp)),$(window).trigger("action:composer.drafts.get",{save_id:e,draft:n,storage:o}),n}catch{return console.warn(`[composer/drafts] Could not get draft ${e}, removing`),i.removeFromDraftList("available"),i.removeFromDraftList("open"),null}};function O(e,r,o){if(p(app.user.uid?"localStorage":"sessionStorage")&&o&&o.save_id&&e.length){const t=e.find("input.title"),n=t&&t.length&&t.val(),s=e.find("textarea").val(),c=m(app.user.uid);if(s.length||n&&n.length){const l={save_id:o.save_id,action:o.action,text:s,uuid:e.attr("data-uuid"),timestamp:Date.now()};if(o.action==="topics.post"){const E=e.find("input.tags").val();l.tags=E,l.title=n,l.cid=o.cid}else o.action==="posts.reply"?(l.title=o.title,l.tid=o.tid,l.toPid=o.toPid):o.action==="posts.edit"&&(l.pid=o.pid,l.title=n||o.title);app.user.uid||(l.handle=e.find("input.handle").val()),c.setItem(o.save_id,JSON.stringify(l)),$(window).trigger("action:composer.drafts.save",{storage:c,postData:o,postContainer:e}),r.toggleClass("active",!0)}else i.removeDraft(o.save_id)}}i.removeDraft=function(e){if(!e)return;i.removeFromDraftList("available",e),i.removeFromDraftList("open",e);const r=e.split(":")[1],o=m(r);o.removeItem(e),$(window).trigger("action:composer.drafts.remove",{storage:o,save_id:e})},i.getList=function(e){try{const r=localStorage.getItem(`drafts:${e}`);return JSON.parse(r)||[]}catch{return console.warn("[composer/drafts] Could not read list of available drafts"),[]}},i.addToDraftList=function(e,r){if(!p(app.user.uid?"localStorage":"sessionStorage")||!r)return;const o=i.getList(e);o.includes(r)||(o.push(r),localStorage.setItem("drafts:"+e,JSON.stringify(o)))},i.removeFromDraftList=function(e,r){if(!p(app.user.uid?"localStorage":"sessionStorage")||!r)return;const o=i.getList(e);o.includes(r)&&(o.splice(o.indexOf(r),1),localStorage.setItem("drafts:"+e,JSON.stringify(o)))},i.migrateGuest=function(){if(p("localStorage")&&app.user.uid){const e=/^composer:\d+:\d$/,r=Object.keys(sessionStorage).filter(function(n){return e.test(n)}),o=new Set([]),t=r.map(function(n){const s=n.split(":");return s[1]=app.user.uid,o.add(s.join(":")),s.join(":")});return r.forEach(function(n,s){localStorage.setItem(t[s],sessionStorage.getItem(n)),sessionStorage.removeItem(n)}),o.forEach(function(n){i.addToDraftList("available",n)}),o}},i.migrateThumbs=function(e,r){if(!app.uid)return;const o=e.attr("data-uuid"),t=i.get(r.save_id);t&&t.uuid&&y.put(`/topics/${t.uuid}/thumbs`,{tid:o}).then(()=>{Promise.all([a.e(20056),a.e(23662),a.e(65285),a.e(40559),a.e(449),a.e(5785),a.e(36159)]).then(function(){var n=[a(71431)];(function(s){s.updateThumbCount(o,e)}).apply(null,n)}).catch(a.oe)})},i.listAvailable=function(){return i.getList("available").map(i.get).filter(Boolean)},i.getAvailableCount=function(){return i.listAvailable().length},i.open=function(e){if(!e)return;const r=i.get(e);L(e,r)},i.loadOpen=function(){if(ajaxify.data.template.login||ajaxify.data.template.register||config.hasOwnProperty("openDraftsOnPageLoad")&&!config.openDraftsOnPageLoad)return;const e=i.getList("available"),r=i.getList("open");e.length&&e.forEach(function(o){if(!o||r.includes(o))return;const t=i.get(o);if(!t||!t.text&&!t.title){i.removeFromDraftList("available",o),i.removeFromDraftList("open",o);return}L(o,t)})};function L(e,r){const t=e.split(":")[1];parseInt(app.user.uid,10)===parseInt(t,10)&&Promise.all([a.e(20056),a.e(23662),a.e(65285),a.e(40559),a.e(449),a.e(5785),a.e(36159)]).then(function(){var n=[a(71431)];(function(s){r.action==="topics.post"?s.newTopic({save_id:r.save_id,cid:r.cid,handle:app.user&&app.user.uid?void 0:utils.escapeHTML(r.handle),title:utils.escapeHTML(r.title),body:r.text,tags:String(r.tags||"").split(",")}):r.action==="posts.reply"?y.get("/topics/"+r.tid,{},function(c,l){if(c)return A.error(c);s.newReply({save_id:r.save_id,tid:r.tid,toPid:r.toPid,title:l.title,body:r.text})}):r.action==="posts.edit"&&s.editPost({save_id:r.save_id,pid:r.pid,title:r.title?utils.escapeHTML(r.title):void 0,body:r.text})}).apply(null,n)}).catch(a.oe)}function p(e){var r;try{r=window[e];var o="__storage_test__";return r.setItem(o,o),r.removeItem(o),!0}catch(t){return t instanceof DOMException&&(t.code===22||t.code===1014||t.name==="QuotaExceededError"||t.name==="NS_ERROR_DOM_QUOTA_REACHED")&&r&&r.length!==0}}return i}.apply(v,h),w!==void 0&&(S.exports=w)},49897:(S,v,a)=>{"use strict";a.r(v),a.d(v,{del:()=>o,get:()=>O,head:()=>L,patch:()=>e,post:()=>p,put:()=>r});var h=a(91749),w=a.n(h),y=a(33530),A=a.n(y);const i=config.relative_path+"/api/v3";async function g(t,n){if(t.url=t.url.startsWith("/api")?config.relative_path+t.url:i+t.url,typeof n=="function"){m(t).then(s=>n(null,s),s=>{let c=s;s instanceof Error||(c=new Error(String(s)));const l=c.message||String(c);if(l&&!l.startsWith("[[error:")&&(l.toLowerCase()==="fetch failed"||l.toLowerCase()==="failed to fetch"||l.toLowerCase().includes("networkerror")||l.toLowerCase().includes("network")&&l.toLowerCase().includes("failed"))){const u=new Error("[[error:no-connection]]");u.originalError=c,c=u}n(c)});return}try{return await m(t)}catch(s){if(s.message==="A valid login session was not found. Please log in and try again."){const{url:c}=await(0,h.fire)("filter:admin.reauth",{url:"login"});return(0,y.confirm)("[[error:api.reauth-required]]",l=>{l&&ajaxify.go(c)})}throw s}}async function m(t){const{url:n}=t;delete t.url,t.headers||(t.headers={}),t.data&&!(t.data instanceof FormData)&&(t.data=JSON.stringify(t.data||{}),t.headers["content-type"]="application/json; charset=utf-8");try{({options:t}=await(0,h.fire)("filter:api.options",{options:t}))}catch(d){console.error("[API] Error in filter:api.options hook:",d)}t.data&&(t.body=t.data,delete t.data);let s;try{s=await fetch(n,t)}catch(d){const f=d.message||d.toString()||String(d),P=d.name||"Error";if(P==="TypeError"&&(f.toLowerCase().includes("fetch")||f.toLowerCase().includes("network")||f.toLowerCase().includes("failed to fetch")||f.toLowerCase().includes("load failed"))||f.toLowerCase().includes("cors")||f.toLowerCase().includes("networkerror")){console.error("[API] Network error:",{url:n,method:t.method||"GET",error:f,name:P});const I=new Error("[[error:no-connection]]");throw I.originalError=d,I}throw console.error("[API] Unexpected fetch error:",{url:n,method:t.method||"GET",error:f,name:P}),d}const{headers:c}=s;if(c.get("x-redirect"))return m({url:c.get("x-redirect"),...t});const l=c.get("content-type"),E=l&&l.startsWith("application/json");let u;if(t.method!=="HEAD")try{E?u=await s.json():u=await s.text()}catch(d){throw console.error("[API] Error parsing response:",{url:n,status:s.status,statusText:s.statusText,contentType:l,error:d.message}),new Error("[[error:invalid-json]]")}if(!s.ok){let d;throw u?E&&u.status&&u.status.message?d=u.status.message:typeof u=="string"?d=u:d=s.statusText||"Request failed":d=s.statusText||"Request failed",new Error(d)}return E&&u&&u.hasOwnProperty("status")&&u.hasOwnProperty("response")?u.response:u}function O(t,n,s){return g({url:t+(n&&Object.keys(n).length?"?"+$.param(n):"")},s)}function L(t,n,s){return g({url:t+(n&&Object.keys(n).length?"?"+$.param(n):""),method:"HEAD"},s)}function p(t,n,s){return g({url:t,method:"POST",data:n,headers:{"x-csrf-token":config.csrf_token}},s)}function e(t,n,s){return g({url:t,method:"PATCH",data:n,headers:{"x-csrf-token":config.csrf_token}},s)}function r(t,n,s){return g({url:t,method:"PUT",data:n,headers:{"x-csrf-token":config.csrf_token}},s)}function o(t,n,s){return g({url:t,method:"DELETE",data:n,headers:{"x-csrf-token":config.csrf_token}},s)}},74566:(S,v,a)=>{S.exports=a(12236)}}]);
