"use strict";(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[1091,34271,37147,49897,73023,99127],{49897:(P,w,c)=>{c.r(w),c.d(w,{del:()=>o,get:()=>C,head:()=>y,patch:()=>l,post:()=>A,put:()=>n});var f=c(91749),m=c.n(f),p=c(33530),v=c.n(p);const g=config.relative_path+"/api/v3";async function d(e,t){if(e.url=e.url.startsWith("/api")?config.relative_path+e.url:g+e.url,typeof t=="function"){h(e).then(r=>t(null,r),r=>{let i=r;r instanceof Error||(i=new Error(String(r)));const u=i.message||String(i);if(u&&!u.startsWith("[[error:")&&(u.toLowerCase()==="fetch failed"||u.toLowerCase()==="failed to fetch"||u.toLowerCase().includes("networkerror")||u.toLowerCase().includes("network")&&u.toLowerCase().includes("failed"))){const s=new Error("[[error:no-connection]]");s.originalError=i,i=s}t(i)});return}try{return await h(e)}catch(r){if(r.message==="A valid login session was not found. Please log in and try again."){const{url:i}=await(0,f.fire)("filter:admin.reauth",{url:"login"});return(0,p.confirm)("[[error:api.reauth-required]]",u=>{u&&ajaxify.go(i)})}throw r}}async function h(e){const{url:t}=e;delete e.url,e.headers||(e.headers={}),e.data&&!(e.data instanceof FormData)&&(e.data=JSON.stringify(e.data||{}),e.headers["content-type"]="application/json; charset=utf-8");try{({options:e}=await(0,f.fire)("filter:api.options",{options:e}))}catch(a){console.error("[API] Error in filter:api.options hook:",a)}e.data&&(e.body=e.data,delete e.data);let r;try{r=await fetch(t,e)}catch(a){const E=a.message||a.toString()||String(a),k=a.name||"Error";if(k==="TypeError"&&(E.toLowerCase().includes("fetch")||E.toLowerCase().includes("network")||E.toLowerCase().includes("failed to fetch")||E.toLowerCase().includes("load failed"))||E.toLowerCase().includes("cors")||E.toLowerCase().includes("networkerror")){console.error("[API] Network error:",{url:t,method:e.method||"GET",error:E,name:k});const D=new Error("[[error:no-connection]]");throw D.originalError=a,D}throw console.error("[API] Unexpected fetch error:",{url:t,method:e.method||"GET",error:E,name:k}),a}const{headers:i}=r;if(i.get("x-redirect"))return h({url:i.get("x-redirect"),...e});const u=i.get("content-type"),T=u&&u.startsWith("application/json");let s;if(e.method!=="HEAD")try{T?s=await r.json():s=await r.text()}catch(a){throw console.error("[API] Error parsing response:",{url:t,status:r.status,statusText:r.statusText,contentType:u,error:a.message}),new Error("[[error:invalid-json]]")}if(!r.ok){let a;throw s?T&&s.status&&s.status.message?a=s.status.message:typeof s=="string"?a=s:a=r.statusText||"Request failed":a=r.statusText||"Request failed",new Error(a)}return T&&s&&s.hasOwnProperty("status")&&s.hasOwnProperty("response")?s.response:s}function C(e,t,r){return d({url:e+(t&&Object.keys(t).length?"?"+$.param(t):"")},r)}function y(e,t,r){return d({url:e+(t&&Object.keys(t).length?"?"+$.param(t):""),method:"HEAD"},r)}function A(e,t,r){return d({url:e,method:"POST",data:t,headers:{"x-csrf-token":config.csrf_token}},r)}function l(e,t,r){return d({url:e,method:"PATCH",data:t,headers:{"x-csrf-token":config.csrf_token}},r)}function n(e,t,r){return d({url:e,method:"PUT",data:t,headers:{"x-csrf-token":config.csrf_token}},r)}function o(e,t,r){return d({url:e,method:"DELETE",data:t,headers:{"x-csrf-token":config.csrf_token}},r)}},53309:(P,w,c)=>{var f,m;f=[c(52473),c(49897),c(29930)],m=function(p,v,g){const d={};let h=[];d.init=function(n){n=n||{},h.length=0,p.get("chat/search").on("keyup",utils.debounce(y,250));const o=$('[component="chat/search/list"]');o.on("click","[data-uid]",function(){n.onSelect&&n.onSelect(h.find(e=>String(e.uid)===String($(this).attr("data-uid")))),C(o)})};function C(n){p.get("chat/search").val(""),A(n),n.find('[component="chat/search/no-users"]').addClass("hidden"),n.find('[component="chat/search/start-typing"]').removeClass("hidden")}function y(){const n=$('[component="chat/search/list"]'),o=p.get("chat/search").val();if(!o)return C(n);n.find('[component="chat/search/start-typing"]').addClass("hidden"),v.get("/api/users",{query:o,searchBy:"username",paginate:!1}).then(l).catch(g.error)}function A(n){h.length=0,n.find("[data-uid]").remove()}async function l(n){const o=$('[component="chat/search/list"]');if(A(o),n.users=n.users.filter(function(t){return parseInt(t.uid,10)!==parseInt(app.user.uid,10)}),h=n.users,!n.users.length)return o.find('[component="chat/search/no-users"]').removeClass("hidden");o.find('[component="chat/search/no-users"]').addClass("hidden");const e=await app.parseAndTranslate("modals/create-room","searchUsers",{searchUsers:n.users});o.append(e),o.parent().toggleClass("show",!0)}return d}.apply(w,f),m!==void 0&&(P.exports=m)},80083:(P,w,c)=>{var f,m;f=[c(52473),c(49897),c(29930),c(53309)],m=function(p,v,g,d){const h={};h.init=function(){p.get("chat/create").on("click",C)};async function C(){let y=[];app.user.isAdmin&&({groups:y}=await v.get("/admin/groups"),y.sort((o,e)=>e.system-o.system).map(o=>{const{name:e,displayName:t}=o;return{name:e,displayName:t}}));const A=await app.parseAndTranslate("modals/create-room",{user:app.user,groups:y}),l=bootbox.dialog({title:"[[modules:chat.create-room]]",message:A,onEscape:!0,buttons:{save:{label:"[[global:create]]",className:"btn-primary",callback:function(){const o=l.find('[component="chat/room/name"]').val(),e=l.find('[component="chat/room/users"] [component="chat/user"]').find("[data-uid]").map((i,u)=>$(u).attr("data-uid")).get(),t=l.find('[component="chat/room/type"]').val(),r=l.find('[component="chat/room/groups"]').val();return t==="private"&&!e.length?(g.error("[[error:no-users-selected]]"),!1):t==="public"&&!r.length?(g.error("[[error:no-groups-selected]]"),!1):app.user.uid?(v.post("/chats",{roomName:o,uids:e,type:t,groups:r}).then(({roomId:i})=>{ajaxify.go("chats/"+i),l.modal("hide")}).catch(g.error),!1):(g.error("[[error:not-logged-in]]"),!1)}}}}),n=l.find('[component="chat/room/users"]');d.init({onSelect:async function(o){const e=await app.parseAndTranslate("modals/create-room","selectedUsers",{selectedUsers:[o]});n.append(e)}}),n.on("click",'[component="chat/room/users/remove"]',function(){$(this).parents("[data-uid]").remove()}),l.find('[component="chat/room/type"]').on("change",function(){const o=$(this).val();l.find('[component="chat/room/public/options"]').toggleClass("hidden",o==="private")})}return h}.apply(w,f),m!==void 0&&(P.exports=m)}}]);
