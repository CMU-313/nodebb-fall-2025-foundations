(self.webpackChunknodebb=self.webpackChunknodebb||[]).push([[1091,34271,36159,46379,49897,52185,62441,74566,88189,92332,98463,99127],{12236:(y,A,i)=>{"use strict";var p,E;p=[i(49897),i(29930)],E=function(m,L){const a={};a.init=function(t,e){const o=t.find(".draft-icon"),r=t.attr("data-uuid");function n(){$(`[component="composer"][data-uuid="${r}"]`).length&&(e.save_id||(e.save_id=utils.generateSaveId(app.user.uid)),a.addToDraftList("available",e.save_id),a.addToDraftList("open",e.save_id),l(t,o,e))}t.on("keyup","textarea, input.handle, input.title",utils.debounce(n,1e3)),t.on("click",'input[type="checkbox"]',utils.debounce(n,1e3)),t.on("click",'[component="category/list"] [data-cid]',utils.debounce(n,1e3)),t.on("itemAdded",".tags",utils.debounce(n,1e3)),t.on("thumb.uploaded",n),o.on("animationend",function(){$(this).toggleClass("active",!1)}),$(window).on("unload",function(){const s=a.getList("open");s.length&&s.forEach(f=>a.removeFromDraftList("open",f))}),a.migrateGuest(),a.migrateThumbs(...arguments)};function S(t){return parseInt(t,10)>0?localStorage:sessionStorage}a.get=function(t){if(!t)return null;const e=t.split(":")[1],o=S(e);try{const r=o.getItem(t),n=JSON.parse(r)||null;if(!n)throw new Error(`can't parse draft json for ${t}`);return n.save_id=t,n.timestamp&&(n.timestampISO=utils.toISOString(n.timestamp)),$(window).trigger("action:composer.drafts.get",{save_id:t,draft:n,storage:o}),n}catch{return console.warn(`[composer/drafts] Could not get draft ${t}, removing`),a.removeFromDraftList("available"),a.removeFromDraftList("open"),null}};function l(t,e,o){if(u(app.user.uid?"localStorage":"sessionStorage")&&o&&o.save_id&&t.length){const r=t.find("input.title"),n=r&&r.length&&r.val(),s=t.find("textarea").val(),f=S(app.user.uid);if(s.length||n&&n.length){const d={save_id:o.save_id,action:o.action,text:s,uuid:t.attr("data-uuid"),timestamp:Date.now()};if(o.action==="topics.post"){const P=t.find("input.tags").val();d.tags=P,d.title=n,d.cid=o.cid}else o.action==="posts.reply"?(d.title=o.title,d.tid=o.tid,d.toPid=o.toPid):o.action==="posts.edit"&&(d.pid=o.pid,d.title=n||o.title);app.user.uid||(d.handle=t.find("input.handle").val()),f.setItem(o.save_id,JSON.stringify(d)),$(window).trigger("action:composer.drafts.save",{storage:f,postData:o,postContainer:t}),e.toggleClass("active",!0)}else a.removeDraft(o.save_id)}}a.removeDraft=function(t){if(!t)return;a.removeFromDraftList("available",t),a.removeFromDraftList("open",t);const e=t.split(":")[1],o=S(e);o.removeItem(t),$(window).trigger("action:composer.drafts.remove",{storage:o,save_id:t})},a.getList=function(t){try{const e=localStorage.getItem(`drafts:${t}`);return JSON.parse(e)||[]}catch{return console.warn("[composer/drafts] Could not read list of available drafts"),[]}},a.addToDraftList=function(t,e){if(!u(app.user.uid?"localStorage":"sessionStorage")||!e)return;const o=a.getList(t);o.includes(e)||(o.push(e),localStorage.setItem("drafts:"+t,JSON.stringify(o)))},a.removeFromDraftList=function(t,e){if(!u(app.user.uid?"localStorage":"sessionStorage")||!e)return;const o=a.getList(t);o.includes(e)&&(o.splice(o.indexOf(e),1),localStorage.setItem("drafts:"+t,JSON.stringify(o)))},a.migrateGuest=function(){if(u("localStorage")&&app.user.uid){const t=/^composer:\d+:\d$/,e=Object.keys(sessionStorage).filter(function(n){return t.test(n)}),o=new Set([]),r=e.map(function(n){const s=n.split(":");return s[1]=app.user.uid,o.add(s.join(":")),s.join(":")});return e.forEach(function(n,s){localStorage.setItem(r[s],sessionStorage.getItem(n)),sessionStorage.removeItem(n)}),o.forEach(function(n){a.addToDraftList("available",n)}),o}},a.migrateThumbs=function(t,e){if(!app.uid)return;const o=t.attr("data-uuid"),r=a.get(e.save_id);r&&r.uuid&&m.put(`/topics/${r.uuid}/thumbs`,{tid:o}).then(()=>{Promise.all([i.e(20056),i.e(23662),i.e(65285),i.e(40559),i.e(449),i.e(5785),i.e(36159)]).then(function(){var n=[i(71431)];(function(s){s.updateThumbCount(o,t)}).apply(null,n)}).catch(i.oe)})},a.listAvailable=function(){return a.getList("available").map(a.get).filter(Boolean)},a.getAvailableCount=function(){return a.listAvailable().length},a.open=function(t){if(!t)return;const e=a.get(t);c(t,e)},a.loadOpen=function(){if(ajaxify.data.template.login||ajaxify.data.template.register||config.hasOwnProperty("openDraftsOnPageLoad")&&!config.openDraftsOnPageLoad)return;const t=a.getList("available"),e=a.getList("open");t.length&&t.forEach(function(o){if(!o||e.includes(o))return;const r=a.get(o);if(!r||!r.text&&!r.title){a.removeFromDraftList("available",o),a.removeFromDraftList("open",o);return}c(o,r)})};function c(t,e){const r=t.split(":")[1];parseInt(app.user.uid,10)===parseInt(r,10)&&Promise.all([i.e(20056),i.e(23662),i.e(65285),i.e(40559),i.e(449),i.e(5785),i.e(36159)]).then(function(){var n=[i(71431)];(function(s){e.action==="topics.post"?s.newTopic({save_id:e.save_id,cid:e.cid,handle:app.user&&app.user.uid?void 0:utils.escapeHTML(e.handle),title:utils.escapeHTML(e.title),body:e.text,tags:String(e.tags||"").split(",")}):e.action==="posts.reply"?m.get("/topics/"+e.tid,{},function(f,d){if(f)return L.error(f);s.newReply({save_id:e.save_id,tid:e.tid,toPid:e.toPid,title:d.title,body:e.text})}):e.action==="posts.edit"&&s.editPost({save_id:e.save_id,pid:e.pid,title:e.title?utils.escapeHTML(e.title):void 0,body:e.text})}).apply(null,n)}).catch(i.oe)}function u(t){var e;try{e=window[t];var o="__storage_test__";return e.setItem(o,o),e.removeItem(o),!0}catch(r){return r instanceof DOMException&&(r.code===22||r.code===1014||r.name==="QuotaExceededError"||r.name==="NS_ERROR_DOM_QUOTA_REACHED")&&e&&e.length!==0}}return a}.apply(A,p),E!==void 0&&(y.exports=E)},24187:(y,A,i)=>{"use strict";var p,E;p=[i(64061)],E=function(){const m={};m.show=function(l,c){const u=l.hasOwnProperty("fileSize")&&l.fileSize!==void 0?parseInt(l.fileSize,10):!1;app.parseAndTranslate("modals/upload-file",{showHelp:l.hasOwnProperty("showHelp")&&l.showHelp!==void 0?l.showHelp:!0,fileSize:u,title:l.title||"[[global:upload-file]]",description:l.description||"",button:l.button||"[[global:upload]]",accept:l.accept?l.accept.replace(/,/g,"&#44; "):""},function(t){t.modal("show"),t.on("hidden.bs.modal",function(){t.remove()});const e=t.find("#uploadForm");e.attr("action",l.route),e.find("#params").val(JSON.stringify(l.params)),t.find("#fileUploadSubmitBtn").on("click",function(){$(this).addClass("disabled"),e.submit()}),e.submit(function(){return L(t,u,c),!1})})},m.hideAlerts=function(l){$(l).find("#alert-status, #alert-success, #alert-error, #upload-progress-box").addClass("hide")};function L(l,c,u){a(l,"status","[[uploads:uploading-file]]"),l.find("#upload-progress-bar").css("width","0%"),l.find("#upload-progress-box").show().removeClass("hide");const t=l.find("#fileInput");if(!t.val())return a(l,"error","[[uploads:select-file-to-upload]]");if(!S(t[0],c))return a(l,"error","[[error:file-too-big, "+c+"]]");m.ajaxSubmit(l,u)}function a(l,c,u){m.hideAlerts(l),c==="error"&&l.find("#fileUploadSubmitBtn").removeClass("disabled"),u=u.replace(/&amp;#44/g,"&#44"),l.find("#alert-"+c).translateText(u).removeClass("hide")}m.ajaxSubmit=function(l,c){l.find("#uploadForm").ajaxSubmit({headers:{"x-csrf-token":config.csrf_token},error:function(t){t=v(t),a(l,"error",t.responseJSON?.status?.message||t.responseJSON?.error||`[[error:upload-error-fallback, ${t.status} ${t.statusText}]]`)},uploadProgress:function(t,e,o,r){l.find("#upload-progress-bar").css("width",r+"%")},success:function(t){let e=v(t);t.hasOwnProperty("response")&&t.hasOwnProperty("status")&&t.status.code==="ok"&&(e=t.response.images),c(e[0].url),a(l,"success","[[uploads:upload-success]]"),setTimeout(function(){m.hideAlerts(l),l.modal("hide")},750)}})};function v(l){if(typeof l=="string")try{return JSON.parse(l)}catch(c){return console.error(c),{error:"[[error:parse-error]]"}}return l}function S(l,c){return window.FileReader&&c?l.files[0].size<=c*1e3:!0}return m}.apply(A,p),E!==void 0&&(y.exports=E)},36159:(y,A,i)=>{"use strict";var p,E;p=[i(49897),i(33530),i(29930),i(24187),i(81335),i(17459),i(65285)],E=function(m,L,a,v,S,l){const c={};return c.get=u=>m.get(`/topics/${u}/thumbs`,{thumbsOnly:1}),c.getByPid=u=>m.get(`/posts/${encodeURIComponent(u)}`,{}).then(t=>c.get(t.tid)),c.delete=(u,t)=>m.del(`/topics/${u}/thumbs`,{path:t}),c.deleteAll=u=>{c.get(u).then(t=>{Promise.all(t.map(e=>c.delete(u,e.url)))})},c.upload=u=>new Promise(t=>{v.show({title:"[[topic:composer.thumb-title]]",method:"put",route:config.relative_path+`/api/v3/topics/${u}/thumbs`},function(e){t(e)})}),c.modal={},c.modal.open=function(u){const{id:t,pid:e}=u;let{modal:o}=u,r;return new Promise(n=>{Promise.all([c.get(t),e?c.getByPid(e):[]]).then(s=>new Promise(f=>{const d=s.reduce((P,g)=>P.concat(g));r=d.length,f(d)})).then(s=>S.render("modals/topic-thumbs",{thumbs:s})).then(s=>{o?l.translate(s,function(f){o.find(".bootbox-body").html(f),c.modal.handleSort({modal:o,numThumbs:r})}):(o=L.dialog({title:"[[modules:thumbs.modal.title]]",message:s,onEscape:!0,backdrop:!0,buttons:{add:{label:'<i class="fa fa-plus"></i> [[modules:thumbs.modal.add]]',className:"btn-success",callback:()=>(c.upload(t).then(()=>{c.modal.open({...u,modal:o}),Promise.all([i.e(20056),i.e(40559),i.e(449),i.e(5785),i.e(52185)]).then(function(){var f=[i(71431)];(d=>{d.updateThumbCount(t,$(`[component="composer"][data-uuid="${t}"]`)),n()}).apply(null,f)}).catch(i.oe)}),!1)},close:{label:"[[global:close]]",className:"btn-primary"}}}),c.modal.handleDelete({...u,modal:o}),c.modal.handleSort({modal:o,numThumbs:r}))})})},c.modal.handleDelete=u=>{const t=u.modal.get(0),{id:e}=u;t.addEventListener("click",o=>{o.target.closest('button[data-action="remove"]')&&L.confirm("[[modules:thumbs.modal.confirm-remove]]",r=>{if(!r)return;const n=o.target.closest("[data-id]").getAttribute("data-id"),s=o.target.closest("[data-path]").getAttribute("data-path");m.del(`/topics/${n}/thumbs`,{path:s}).then(()=>{c.modal.open(u),Promise.all([i.e(20056),i.e(40559),i.e(449),i.e(5785),i.e(52185)]).then(function(){var f=[i(71431)];(d=>{d.updateThumbCount(e,$(`[component="composer"][data-uuid="${e}"]`))}).apply(null,f)}).catch(i.oe)}).catch(a.error)})})},c.modal.handleSort=({modal:u,numThumbs:t})=>{if(t>1){const e=u.find(".topic-thumbs-modal");e.sortable({items:"[data-id]"}),e.on("sortupdate",c.modal.handleSortChange)}},c.modal.handleSortChange=(u,t)=>{const e=t.item.get(0).parentNode.querySelectorAll("[data-id]");Array.from(e).forEach((o,r)=>{const n=o.getAttribute("data-id");let s=o.getAttribute("data-path");s=s.replace(new RegExp(`^${config.upload_url}`),""),m.put(`/topics/${n}/thumbs/order`,{path:s,order:r}).catch(a.error)})},c}.apply(A,p),E!==void 0&&(y.exports=E)},49897:(y,A,i)=>{"use strict";i.r(A),i.d(A,{del:()=>o,get:()=>l,head:()=>c,patch:()=>t,post:()=>u,put:()=>e});var p=i(91749),E=i.n(p),m=i(33530),L=i.n(m);const a=config.relative_path+"/api/v3";async function v(r,n){if(r.url=r.url.startsWith("/api")?config.relative_path+r.url:a+r.url,typeof n=="function"){S(r).then(s=>n(null,s),s=>{let f=s;s instanceof Error||(f=new Error(String(s)));const d=f.message||String(f);if(d&&!d.startsWith("[[error:")&&(d.toLowerCase()==="fetch failed"||d.toLowerCase()==="failed to fetch"||d.toLowerCase().includes("networkerror")||d.toLowerCase().includes("network")&&d.toLowerCase().includes("failed"))){const g=new Error("[[error:no-connection]]");g.originalError=f,f=g}n(f)});return}try{return await S(r)}catch(s){if(s.message==="A valid login session was not found. Please log in and try again."){const{url:f}=await(0,p.fire)("filter:admin.reauth",{url:"login"});return(0,m.confirm)("[[error:api.reauth-required]]",d=>{d&&ajaxify.go(f)})}throw s}}async function S(r){const{url:n}=r;delete r.url,r.headers||(r.headers={}),r.data&&!(r.data instanceof FormData)&&(r.data=JSON.stringify(r.data||{}),r.headers["content-type"]="application/json; charset=utf-8");try{({options:r}=await(0,p.fire)("filter:api.options",{options:r}))}catch(h){console.error("[API] Error in filter:api.options hook:",h)}r.data&&(r.body=r.data,delete r.data);let s;try{s=await fetch(n,r)}catch(h){const b=h.message||h.toString()||String(h),O=h.name||"Error";if(O==="TypeError"&&(b.toLowerCase().includes("fetch")||b.toLowerCase().includes("network")||b.toLowerCase().includes("failed to fetch")||b.toLowerCase().includes("load failed"))||b.toLowerCase().includes("cors")||b.toLowerCase().includes("networkerror")){console.error("[API] Network error:",{url:n,method:r.method||"GET",error:b,name:O});const w=new Error("[[error:no-connection]]");throw w.originalError=h,w}throw console.error("[API] Unexpected fetch error:",{url:n,method:r.method||"GET",error:b,name:O}),h}const{headers:f}=s;if(f.get("x-redirect"))return S({url:f.get("x-redirect"),...r});const d=f.get("content-type"),P=d&&d.startsWith("application/json");let g;if(r.method!=="HEAD")try{P?g=await s.json():g=await s.text()}catch(h){throw console.error("[API] Error parsing response:",{url:n,status:s.status,statusText:s.statusText,contentType:d,error:h.message}),new Error("[[error:invalid-json]]")}if(!s.ok){let h;throw g?P&&g.status&&g.status.message?h=g.status.message:typeof g=="string"?h=g:h=s.statusText||"Request failed":h=s.statusText||"Request failed",new Error(h)}return P&&g&&g.hasOwnProperty("status")&&g.hasOwnProperty("response")?g.response:g}function l(r,n,s){return v({url:r+(n&&Object.keys(n).length?"?"+$.param(n):"")},s)}function c(r,n,s){return v({url:r+(n&&Object.keys(n).length?"?"+$.param(n):""),method:"HEAD"},s)}function u(r,n,s){return v({url:r,method:"POST",data:n,headers:{"x-csrf-token":config.csrf_token}},s)}function t(r,n,s){return v({url:r,method:"PATCH",data:n,headers:{"x-csrf-token":config.csrf_token}},s)}function e(r,n,s){return v({url:r,method:"PUT",data:n,headers:{"x-csrf-token":config.csrf_token}},s)}function o(r,n,s){return v({url:r,method:"DELETE",data:n,headers:{"x-csrf-token":config.csrf_token}},s)}},74566:(y,A,i)=>{y.exports=i(12236)}}]);
